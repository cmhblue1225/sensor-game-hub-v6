<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸï¸ 3D ë ˆì´ì‹± ê²Œì„</title>
    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --background: #0f172a;
            --surface: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --border: #475569;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        /* ê²Œì„ ì»¨í…Œì´ë„ˆ */
        .game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: linear-gradient(to bottom, #87CEEB 0%, #98FB98 100%);
        }

        /* í™”ë©´ ë¶„í•  */
        .split-screen {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .viewport {
            flex: 1;
            position: relative;
            overflow: hidden;
            border-right: 2px solid #333;
            perspective: 1000px;
        }

        .viewport:last-child {
            border-right: none;
        }

        /* 3D íŠ¸ë™ */
        .track-3d {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
        }

        /* íŠ¸ë™ ì„¸ê·¸ë¨¼íŠ¸ */
        .track-segment {
            position: absolute;
            width: 100%;
            height: 200px;
            background: linear-gradient(to right,
                    #228B22 0%, #228B22 20%,
                    #666 20%, #666 80%,
                    #228B22 80%, #228B22 100%);
            border-bottom: 4px solid #fff;
            transform-style: preserve-3d;
        }

        /* ìë™ì°¨ */
        .car {
            position: absolute;
            width: 40px;
            height: 80px;
            left: 50%;
            bottom: 100px;
            margin-left: -20px;
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out;
        }

        .car-body {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #ff4444, #cc0000);
            border-radius: 20px 20px 5px 5px;
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .car.player2 .car-body {
            background: linear-gradient(45deg, #4444ff, #0000cc);
        }

        .car-windshield {
            position: absolute;
            top: 10px;
            left: 5px;
            right: 5px;
            height: 30px;
            background: rgba(135, 206, 235, 0.8);
            border-radius: 15px 15px 0 0;
        }

        .car-wheels {
            position: absolute;
            width: 8px;
            height: 12px;
            background: #222;
            border-radius: 2px;
        }

        .wheel-fl {
            top: 15px;
            left: -4px;
        }

        .wheel-fr {
            top: 15px;
            right: -4px;
        }

        .wheel-bl {
            bottom: 15px;
            left: -4px;
        }

        .wheel-br {
            bottom: 15px;
            right: -4px;
        }

        /* UI ìŠ¤íƒ€ì¼ */
        .game-ui {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 100;
        }

        .ui-panel {
            position: absolute;
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.25rem;
            backdrop-filter: blur(12px);
            pointer-events: all;
        }

        .session-panel {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            min-width: 400px;
        }

        .session-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .session-code {
            font-size: 3rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            color: var(--primary);
            margin: 1.5rem 0;
            padding: 1rem;
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid var(--primary);
            border-radius: 0.75rem;
            letter-spacing: 0.3em;
        }

        .qr-container {
            margin: 1.5rem 0;
            padding: 1rem;
            background: white;
            border-radius: 0.75rem;
            display: inline-block;
        }

        .control-panel {
            bottom: 1rem;
            left: 1rem;
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        /* HUD */
        .hud {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 50;
            pointer-events: none;
        }

        .player-hud {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            min-width: 200px;
            backdrop-filter: blur(8px);
        }

        .player-hud h3 {
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
            color: var(--primary);
        }

        .hud-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .hud-stat .label {
            color: var(--text-secondary);
        }

        .hud-stat .value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .hidden {
            display: none !important;
        }

        /* ê²Œì„ ëª¨ë“œ ì„ íƒ */
        .mode-selection {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            z-index: 200;
            backdrop-filter: blur(12px);
        }

        .mode-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: center;
        }

        .mode-btn {
            padding: 1rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .mode-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }

        /* íŠ¸ë™ ì„ íƒ */
        .track-selection {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            z-index: 200;
            backdrop-filter: blur(12px);
        }

        .track-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .track-btn {
            padding: 1.5rem;
            background: var(--surface);
            color: var(--text-primary);
            border: 2px solid var(--border);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .track-btn:hover {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }

        .track-btn.selected {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.2);
        }

        .track-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .track-difficulty {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* ê²°ê³¼ í™”ë©´ */
        .results-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            z-index: 200;
            backdrop-filter: blur(12px);
            min-width: 400px;
        }

        .winner-text {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--success);
        }

        .race-stats {
            margin: 1.5rem 0;
            text-align: left;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.25rem;
        }
    </style>
</head>

<body>
    <div class="game-container">
        <!-- í™”ë©´ ë¶„í•  -->
        <div class="split-screen hidden" id="gameScreen">
            <div class="viewport" id="viewport1">
                <div class="track-3d" id="track1">
                    <!-- í”Œë ˆì´ì–´ 1 ìë™ì°¨ -->
                    <div class="car player1" id="car1">
                        <div class="car-body">
                            <div class="car-windshield"></div>
                            <div class="car-wheels wheel-fl"></div>
                            <div class="car-wheels wheel-fr"></div>
                            <div class="car-wheels wheel-bl"></div>
                            <div class="car-wheels wheel-br"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="viewport" id="viewport2">
                <div class="track-3d" id="track2">
                    <!-- í”Œë ˆì´ì–´ 2 ìë™ì°¨ -->
                    <div class="car player2" id="car2">
                        <div class="car-body">
                            <div class="car-windshield"></div>
                            <div class="car-wheels wheel-fl"></div>
                            <div class="car-wheels wheel-fr"></div>
                            <div class="car-wheels wheel-bl"></div>
                            <div class="car-wheels wheel-br"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ê²Œì„ UI -->
    <div class="game-ui">
        <!-- ì„¸ì…˜ ëŒ€ê¸° íŒ¨ë„ -->
        <div class="ui-panel session-panel" id="sessionPanel">
            <div class="session-title">ğŸï¸ 3D ë ˆì´ì‹± ê²Œì„</div>
            <div style="color: var(--text-secondary); margin-bottom: 1.5rem; line-height: 1.6;">
                ë‘ ëª…ì´ í•¨ê»˜ ì¦ê¸°ëŠ” 3D ë ˆì´ì‹± ê²½ìŸ!<br>
                í™”ë©´ ë¶„í• ë¡œ ê°ìì˜ ì‹œì ì—ì„œ ê²½ì£¼í•˜ì„¸ìš”
            </div>

            <div class="session-code" id="sessionCode">----</div>

            <div class="qr-container" id="qrContainer">
                <div style="color: #666; padding: 2rem;">QR ì½”ë“œ ìƒì„± ì¤‘...</div>
            </div>

            <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 1rem;">
                ğŸ“± ëª¨ë°”ì¼ë¡œ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ê±°ë‚˜<br>
                ì„¼ì„œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„¸ì…˜ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”<br><br>
                <strong>ì¡°ì‘ë²•:</strong><br>
                ì¢Œìš° ê¸°ìš¸ê¸° â†’ í•¸ë“¤ ì¡°ì‘<br>
                ì•ë’¤ ê¸°ìš¸ê¸° â†’ ê°€ì†/ë¸Œë ˆì´í¬<br>
                <strong>í…ŒìŠ¤íŠ¸:</strong> í‚¤ë³´ë“œ WASD / í™”ì‚´í‘œí‚¤
            </div>
        </div>

        <!-- ê²Œì„ ëª¨ë“œ ì„ íƒ -->
        <div class="mode-selection hidden" id="modeSelection">
            <h2>ê²Œì„ ëª¨ë“œ ì„ íƒ</h2>
            <p style="color: var(--text-secondary); margin: 1rem 0;">
                ì›í•˜ëŠ” ê²½ì£¼ ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”
            </p>
            <div class="mode-buttons">
                <button class="mode-btn" data-mode="quick">
                    ğŸ ë¹ ë¥¸ ê²½ì£¼<br>
                    <small>3ë© ê²½ì£¼</small>
                </button>
                <button class="mode-btn" data-mode="best-of-3">
                    ğŸ† ë² ìŠ¤íŠ¸ ì˜¤ë¸Œ 3<br>
                    <small>3ì „ 2ìŠ¹</small>
                </button>
                <button class="mode-btn" data-mode="time-attack">
                    â±ï¸ íƒ€ì„ ì–´íƒ<br>
                    <small>ì œí•œì‹œê°„ ê²½ì£¼</small>
                </button>
            </div>
        </div>

        <!-- íŠ¸ë™ ì„ íƒ -->
        <div class="track-selection hidden" id="trackSelection">
            <h2>íŠ¸ë™ ì„ íƒ</h2>
            <p style="color: var(--text-secondary); margin: 1rem 0;">
                ê²½ì£¼í•  íŠ¸ë™ì„ ì„ íƒí•˜ì„¸ìš”
            </p>
            <div class="track-buttons">
                <div class="track-btn" onclick="game.selectTrack('speedway')">
                    <div class="track-name">ğŸ ìŠ¤í”¼ë“œì›¨ì´</div>
                    <div class="track-difficulty">ë‚œì´ë„: ì‰¬ì›€</div>
                </div>
                <div class="track-btn" onclick="game.selectTrack('mountain')">
                    <div class="track-name">ğŸ”ï¸ ì‚°ì•… ì½”ìŠ¤</div>
                    <div class="track-difficulty">ë‚œì´ë„: ë³´í†µ</div>
                </div>
                <div class="track-btn" onclick="game.selectTrack('city')">
                    <div class="track-name">ğŸ™ï¸ ë„ì‹¬ ì„œí‚·</div>
                    <div class="track-difficulty">ë‚œì´ë„: ì–´ë ¤ì›€</div>
                </div>
            </div>
            <div style="margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="game.startRaceWithTrack()">ê²½ì£¼ ì‹œì‘</button>
            </div>
        </div>

        <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
        <div class="ui-panel control-panel hidden" id="controlPanel">
            <button class="btn btn-secondary" onclick="game.resetGame()">ğŸ”„ ì¬ì‹œì‘</button>
            <button class="btn btn-secondary" onclick="game.pauseGame()">â¸ï¸ ì¼ì‹œì •ì§€</button>
            <a href="/" class="btn btn-secondary">ğŸ  í—ˆë¸Œë¡œ</a>
        </div>

        <!-- HUD -->
        <div class="hud hidden" id="gameHUD">
            <div class="player-hud">
                <h3>Player 1 ğŸ”´</h3>
                <div class="hud-stat">
                    <span class="label">ì†ë„:</span>
                    <span class="value" id="p1Speed">0 km/h</span>
                </div>
                <div class="hud-stat">
                    <span class="label">ë©:</span>
                    <span class="value" id="p1Lap">0/3</span>
                </div>
                <div class="hud-stat">
                    <span class="label">ì‹œê°„:</span>
                    <span class="value" id="p1Time">00:00</span>
                </div>
                <div class="hud-stat">
                    <span class="label">ìˆœìœ„:</span>
                    <span class="value" id="p1Rank">-</span>
                </div>
            </div>

            <div class="player-hud">
                <h3>Player 2 ğŸ”µ</h3>
                <div class="hud-stat">
                    <span class="label">ì†ë„:</span>
                    <span class="value" id="p2Speed">0 km/h</span>
                </div>
                <div class="hud-stat">
                    <span class="label">ë©:</span>
                    <span class="value" id="p2Lap">0/3</span>
                </div>
                <div class="hud-stat">
                    <span class="label">ì‹œê°„:</span>
                    <span class="value" id="p2Time">00:00</span>
                </div>
                <div class="hud-stat">
                    <span class="label">ìˆœìœ„:</span>
                    <span class="value" id="p2Rank">-</span>
                </div>
            </div>
        </div>

        <!-- ê²°ê³¼ íŒ¨ë„ -->
        <div class="results-panel hidden" id="resultsPanel">
            <div class="winner-text" id="winnerText">ğŸ† Player 1 ìŠ¹ë¦¬!</div>
            <div class="race-stats" id="raceStats">
                <!-- ê²½ì£¼ ê²°ê³¼ í†µê³„ -->
            </div>
            <div style="margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="game.nextRace()">ë‹¤ìŒ ê²½ì£¼</button>
                <button class="btn btn-secondary" onclick="game.resetGame()">ìƒˆ ê²Œì„</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="/js/SessionSDK.js"></script>

    <script>
        class Racing3DGame {
            constructor() {
                this.sdk = new SessionSDK({
                    gameId: 'racing-3d',
                    gameType: 'dual',
                    debug: true
                });

                this.gameState = 'waiting';
                this.gameMode = null;
                this.connectedSensors = new Set();

                this.players = {
                    sensor1: {
                        connected: false,
                        car: document.getElementById('car1'),
                        track: document.getElementById('track1'),
                        position: { x: 0, y: 0, z: 0 },
                        velocity: { x: 0, y: 0, z: 0 },
                        rotation: 0,
                        speed: 0,
                        steering: 0,
                        acceleration: 0,
                        lapCount: 0,
                        lapTime: 0,
                        totalTime: 0,
                        bestLapTime: Infinity,
                        rank: 1,
                        trackOffset: 0
                    },
                    sensor2: {
                        connected: false,
                        car: document.getElementById('car2'),
                        track: document.getElementById('track2'),
                        position: { x: 0, y: 0, z: 0 },
                        velocity: { x: 0, y: 0, z: 0 },
                        rotation: 0,
                        speed: 0,
                        steering: 0,
                        acceleration: 0,
                        lapCount: 0,
                        lapTime: 0,
                        totalTime: 0,
                        bestLapTime: Infinity,
                        rank: 2,
                        trackOffset: 0
                    }
                };

                this.gameModes = {
                    'quick': { laps: 3, description: 'ë¹ ë¥¸ ê²½ì£¼' },
                    'best-of-3': { races: 3, wins: 2, description: 'ë² ìŠ¤íŠ¸ ì˜¤ë¸Œ 3' },
                    'time-attack': { timeLimit: 120, description: 'íƒ€ì„ ì–´íƒ' }
                };

                this.raceStartTime = 0;
                this.raceWins = { sensor1: 0, sensor2: 0 };
                this.currentRace = 1;

                this.elements = {
                    sessionPanel: document.getElementById('sessionPanel'),
                    modeSelection: document.getElementById('modeSelection'),
                    trackSelection: document.getElementById('trackSelection'),
                    gameScreen: document.getElementById('gameScreen'),
                    controlPanel: document.getElementById('controlPanel'),
                    gameHUD: document.getElementById('gameHUD'),
                    resultsPanel: document.getElementById('resultsPanel'),
                    sessionCode: document.getElementById('sessionCode'),
                    qrContainer: document.getElementById('qrContainer')
                };

                this.tracks = {
                    'speedway': { name: 'ğŸ ìŠ¤í”¼ë“œì›¨ì´', difficulty: 'ì‰¬ì›€', friction: 0.95, maxSpeed: 1.2 },
                    'mountain': { name: 'ğŸ”ï¸ ì‚°ì•… ì½”ìŠ¤', difficulty: 'ë³´í†µ', friction: 0.90, maxSpeed: 1.0 },
                    'city': { name: 'ğŸ™ï¸ ë„ì‹¬ ì„œí‚·', difficulty: 'ì–´ë ¤ì›€', friction: 0.85, maxSpeed: 0.8 }
                };
                this.selectedTrack = 'speedway';

                this.audioContext = null;
                this.audioEnabled = false;
                this.initAudio();

                this.setupEventListeners();
                this.generateTrackSegments();
                this.startGameLoop();

                console.log('ğŸï¸ 3D ë ˆì´ì‹± ê²Œì„ ì´ˆê¸°í™” ì™„ë£Œ');
            }

            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.audioEnabled = true;
                    console.log('ğŸ”Š ì˜¤ë””ì˜¤ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
                } catch (error) {
                    console.warn('ì˜¤ë””ì˜¤ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    this.audioEnabled = false;
                }
            }

            setupEventListeners() {
                this.sdk.on('connected', () => {
                    console.log('âœ… ì„œë²„ ì—°ê²° ì™„ë£Œ');
                    this.createSession();
                });

                this.sdk.on('session-created', (event) => {
                    const session = event.detail || event;
                    console.log('âœ… ì„¸ì…˜ ìƒì„±:', session.sessionCode);
                    this.elements.sessionCode.textContent = session.sessionCode;
                    this.generateQRCode(session.sessionCode);
                });

                this.sdk.on('sensor-connected', (event) => {
                    const data = event.detail || event;
                    this.handleSensorConnected(data.sensorId);
                });

                this.sdk.on('sensor-data', (event) => {
                    const data = event.detail || event;
                    this.handleSensorData(data);
                });

                this.sdk.on('sensor-disconnected', (event) => {
                    const data = event.detail || event;
                    this.handleSensorDisconnected(data.sensorId);
                });

                this.setupKeyboardControls();
            }

            setupKeyboardControls() {
                const keys = {};

                document.addEventListener('keydown', (event) => {
                    keys[event.key] = true;
                    if (this.gameState === 'racing') {
                        this.handleKeyboardInput(keys);
                    }
                });

                document.addEventListener('keyup', (event) => {
                    keys[event.key] = false;
                    if (this.gameState === 'racing') {
                        this.handleKeyboardInput(keys);
                    }
                });

                this.keyboardKeys = keys;
            }

            handleKeyboardInput(keys) {
                let p1Steering = 0, p1Acceleration = 0;
                if (keys['a'] || keys['A']) p1Steering = -1;
                if (keys['d'] || keys['D']) p1Steering = 1;
                if (keys['w'] || keys['W']) p1Acceleration = 1;
                if (keys['s'] || keys['S']) p1Acceleration = -0.5;

                this.updateCarInput('sensor1', p1Steering, p1Acceleration);

                let p2Steering = 0, p2Acceleration = 0;
                if (keys['ArrowLeft']) p2Steering = -1;
                if (keys['ArrowRight']) p2Steering = 1;
                if (keys['ArrowUp']) p2Acceleration = 1;
                if (keys['ArrowDown']) p2Acceleration = -0.5;

                this.updateCarInput('sensor2', p2Steering, p2Acceleration);
            }

            async createSession() {
                try {
                    await this.sdk.createSession();
                } catch (error) {
                    console.error('ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨:', error);
                }
            }

            generateQRCode(sessionCode) {
                const qrUrl = `${window.location.origin}/sensor.html?session=${sessionCode}`;

                if (typeof QRCode !== 'undefined') {
                    QRCode.toCanvas(document.createElement('canvas'), qrUrl, (error, canvas) => {
                        if (!error) {
                            canvas.style.width = '200px';
                            canvas.style.height = '200px';
                            this.elements.qrContainer.innerHTML = '';
                            this.elements.qrContainer.appendChild(canvas);
                        } else {
                            console.error('QR ì½”ë“œ ìƒì„± ì‹¤íŒ¨:', error);
                            this.showQRCodeFallback(qrUrl);
                        }
                    });
                } else {
                    console.warn('QRCode ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í´ë°± ì‚¬ìš©.');
                    this.showQRCodeFallback(qrUrl);
                }
            }

            showQRCodeFallback(qrUrl) {
                const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrUrl)}`;
                const img = document.createElement('img');
                img.src = qrApiUrl;
                img.style.width = '200px';
                img.style.height = '200px';
                img.alt = 'QR Code';

                this.elements.qrContainer.innerHTML = '';
                this.elements.qrContainer.appendChild(img);
            }

            handleSensorConnected(sensorId) {
                this.connectedSensors.add(sensorId);
                this.players[sensorId].connected = true;

                console.log(`âœ… ${sensorId} ì„¼ì„œ ì—°ê²°ë¨`);
                console.log(`ì—°ê²°ëœ ì„¼ì„œ ìˆ˜: ${this.connectedSensors.size}`);

                if (this.connectedSensors.size >= 2) {
                    console.log('ğŸ® ëª¨ë“  ì„¼ì„œ ì—°ê²° ì™„ë£Œ, ëª¨ë“œ ì„ íƒ í™”ë©´ í‘œì‹œ');
                    setTimeout(() => {
                        this.showModeSelection();
                    }, 500);
                }
            }

            handleSensorDisconnected(sensorId) {
                this.connectedSensors.delete(sensorId);
                this.players[sensorId].connected = false;

                console.log(`âš ï¸ ${sensorId} ì„¼ì„œ ì—°ê²° í•´ì œ`);

                if (this.gameState === 'racing') {
                    this.pauseGame();
                }
            }

            handleSensorData(data) {
                const { sensorId, data: sensorData } = data;

                if (!sensorData || !sensorData.orientation) return;

                const { orientation } = sensorData;
                const { beta, gamma } = orientation;

                let steering = Math.max(-1, Math.min(1, gamma * 0.03));
                let acceleration = 0;

                if (beta < -15) acceleration = 1;
                else if (beta > 15) acceleration = -0.5;

                this.updateCarInput(sensorId, steering, acceleration);
            }

            updateCarInput(sensorId, steering, acceleration) {
                const player = this.players[sensorId];
                if (!player || !player.connected) return;

                player.steering = steering;
                player.acceleration = acceleration;
            }

            showModeSelection() {
                console.log('ğŸ® showModeSelection í˜¸ì¶œë¨');
                this.gameState = 'mode-selection';

                console.log('ì„¸ì…˜ íŒ¨ë„ ìˆ¨ê¸°ê¸°');
                this.elements.sessionPanel.classList.add('hidden');

                console.log('ëª¨ë“œ ì„ íƒ íŒ¨ë„ í‘œì‹œ');
                this.elements.modeSelection.classList.remove('hidden');

                console.log('ëª¨ë“œ ì„ íƒ í™”ë©´ í‘œì‹œ ì™„ë£Œ');
            }

            selectMode(mode) {
                console.log(`ğŸ¯ selectMode í˜¸ì¶œë¨: ${mode}`);
                this.gameMode = mode;
                this.elements.modeSelection.classList.add('hidden');
                this.showTrackSelection();
            }

            showTrackSelection() {
                this.elements.trackSelection.classList.remove('hidden');

                document.querySelectorAll('.track-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                document.querySelector('.track-btn').classList.add('selected');
            }

            selectTrack(trackId) {
                this.selectedTrack = trackId;

                document.querySelectorAll('.track-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                event.target.closest('.track-btn').classList.add('selected');
            }

            startRaceWithTrack() {
                this.elements.trackSelection.classList.add('hidden');
                this.startRace();
            }

            startRace() {
                this.gameState = 'racing';
                this.raceStartTime = Date.now();

                this.elements.gameScreen.classList.remove('hidden');
                this.elements.controlPanel.classList.remove('hidden');
                this.elements.gameHUD.classList.remove('hidden');

                Object.values(this.players).forEach(player => {
                    player.position = { x: 0, y: 0, z: 0 };
                    player.velocity = { x: 0, y: 0, z: 0 };
                    player.rotation = 0;
                    player.speed = 0;
                    player.lapCount = 0;
                    player.lapTime = 0;
                    player.totalTime = 0;
                    player.trackOffset = 0;
                });

                console.log(`ğŸ ${this.gameModes[this.gameMode].description} ì‹œì‘! íŠ¸ë™: ${this.tracks[this.selectedTrack].name}`);
            }

            generateTrackSegments() {
                ['track1', 'track2'].forEach(trackId => {
                    const track = document.getElementById(trackId);

                    for (let i = 0; i < 20; i++) {
                        const segment = document.createElement('div');
                        segment.className = 'track-segment';
                        segment.style.transform = `translateZ(${-i * 200}px)`;
                        track.appendChild(segment);
                    }
                });
            }

            startGameLoop() {
                const gameLoop = () => {
                    if (this.gameState === 'racing') {
                        this.updatePhysics();
                        this.updateCars();
                        this.updateTracks();
                        this.updateHUD();
                        this.checkRaceConditions();
                    }

                    requestAnimationFrame(gameLoop);
                };

                gameLoop();
            }

            updatePhysics() {
                Object.entries(this.players).forEach(([sensorId, player]) => {
                    if (!player.connected) return;

                    const trackSettings = this.tracks[this.selectedTrack];

                    const forwardX = Math.sin(player.rotation * Math.PI / 180);
                    const forwardZ = Math.cos(player.rotation * Math.PI / 180);

                    if (player.acceleration !== 0) {
                        const maxAccel = trackSettings.maxSpeed * 0.3;
                        player.velocity.x += forwardX * player.acceleration * maxAccel;
                        player.velocity.z += forwardZ * player.acceleration * maxAccel;
                    }

                    if (Math.abs(player.steering) > 0.01 && Math.abs(player.speed) > 0.1) {
                        player.rotation += player.steering * player.speed * 1.5;
                    }

                    player.velocity.x *= trackSettings.friction;
                    player.velocity.z *= trackSettings.friction;

                    player.position.x += player.velocity.x;
                    player.position.z += player.velocity.z;

                    player.speed = Math.sqrt(player.velocity.x ** 2 + player.velocity.z ** 2);

                    if (Math.abs(player.position.x) > 150) {
                        player.velocity.x *= 0.7;
                        player.position.x = Math.sign(player.position.x) * 150;
                        this.showOffRoadWarning(sensorId);
                    }

                    player.trackOffset += player.speed * 2;

                    if (player.speed > 0.1) {
                        this.playEngineSound(sensorId, player.speed);
                    }

                    const lapDistance = 5000;
                    const newLapCount = Math.floor(player.trackOffset / lapDistance);
                    if (newLapCount > player.lapCount) {
                        player.lapCount = newLapCount;
                        const currentTime = (Date.now() - this.raceStartTime) / 1000;
                        const lapTime = currentTime - player.totalTime;
                        player.lapTime = lapTime;
                        player.totalTime = currentTime;

                        if (lapTime < player.bestLapTime) {
                            player.bestLapTime = lapTime;
                        }

                        console.log(`ğŸ ${sensorId} ë© ${player.lapCount} ì™„ì£¼! ì‹œê°„: ${lapTime.toFixed(2)}ì´ˆ`);
                    }
                });
            }

            playEngineSound(sensorId, speed) {
                if (!this.audioEnabled || !this.audioContext) return;

                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    const panNode = this.audioContext.createStereoPanner();

                    panNode.pan.value = sensorId === 'sensor1' ? -0.7 : 0.7;

                    oscillator.frequency.value = 100 + speed * 20;
                    gainNode.gain.value = Math.min(0.1, speed * 0.02);

                    oscillator.connect(gainNode);
                    gainNode.connect(panNode);
                    panNode.connect(this.audioContext.destination);

                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + 0.1);
                } catch (error) {
                    console.warn('ì—”ì§„ ì‚¬ìš´ë“œ ì¬ìƒ ì‹¤íŒ¨:', error);
                }
            }

            showOffRoadWarning(sensorId) {
                const playerNum = sensorId === 'sensor1' ? 1 : 2;
                const viewport = document.getElementById(`viewport${playerNum}`);

                viewport.style.filter = 'sepia(0.3) saturate(1.5)';
                setTimeout(() => {
                    viewport.style.filter = '';
                }, 500);
            }

            updateCars() {
                Object.values(this.players).forEach(player => {
                    if (!player.car) return;

                    const transform = `
                        translateX(${player.position.x}px)
                        translateZ(${player.position.z}px)
                        rotateY(${player.rotation}deg)
                    `;

                    player.car.style.transform = transform;
                });
            }

            updateTracks() {
                Object.entries(this.players).forEach(([sensorId, player]) => {
                    if (!player.track) return;

                    const trackTransform = `
                        translateZ(${player.trackOffset}px)
                        rotateY(${-player.rotation}deg)
                    `;

                    player.track.style.transform = trackTransform;
                });
            }

            updateHUD() {
                Object.entries(this.players).forEach(([sensorId, player], index) => {
                    const playerNum = index + 1;
                    const speedKmh = Math.round(player.speed * 10);
                    const currentTime = (Date.now() - this.raceStartTime) / 1000;

                    document.getElementById(`p${playerNum}Speed`).textContent = `${speedKmh} km/h`;
                    document.getElementById(`p${playerNum}Lap`).textContent = `${player.lapCount}/${this.gameModes[this.gameMode]?.laps || 3}`;
                    document.getElementById(`p${playerNum}Time`).textContent = this.formatTime(currentTime);

                    const ranks = this.calculateRanks();
                    document.getElementById(`p${playerNum}Rank`).textContent = ranks[sensorId];
                });
            }

            calculateRanks() {
                const players = Object.entries(this.players);
                players.sort((a, b) => {
                    const [, playerA] = a;
                    const [, playerB] = b;

                    if (playerA.lapCount !== playerB.lapCount) {
                        return playerB.lapCount - playerA.lapCount;
                    }

                    return playerB.trackOffset - playerA.trackOffset;
                });

                const ranks = {};
                players.forEach(([sensorId], index) => {
                    ranks[sensorId] = index + 1;
                });

                return ranks;
            }

            checkRaceConditions() {
                const targetLaps = this.gameModes[this.gameMode]?.laps || 3;

                Object.entries(this.players).forEach(([sensorId, player]) => {
                    if (player.lapCount >= targetLaps) {
                        this.finishRace(sensorId);
                    }
                });

                if (this.gameMode === 'time-attack') {
                    const elapsed = (Date.now() - this.raceStartTime) / 1000;
                    if (elapsed >= this.gameModes['time-attack'].timeLimit) {
                        this.finishTimeAttack();
                    }
                }
            }

            finishRace(winnerId) {
                this.gameState = 'finished';

                const winner = winnerId === 'sensor1' ? 'Player 1' : 'Player 2';

                this.playVictorySound();

                if (this.gameMode === 'best-of-3') {
                    this.raceWins[winnerId]++;

                    if (this.raceWins[winnerId] >= 2) {
                        this.showResults(winner, true);
                    } else {
                        this.showResults(winner, false);
                    }
                } else {
                    this.showResults(winner, true);
                }
            }

            finishTimeAttack() {
                const p1Laps = this.players.sensor1.lapCount;
                const p2Laps = this.players.sensor2.lapCount;

                let winner;
                if (p1Laps > p2Laps) winner = 'Player 1';
                else if (p2Laps > p1Laps) winner = 'Player 2';
                else winner = 'ë¬´ìŠ¹ë¶€';

                this.playVictorySound();
                this.showResults(winner, true);
            }

            playVictorySound() {
                if (!this.audioEnabled || !this.audioContext) return;

                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();

                    oscillator.frequency.value = 523;
                    gainNode.gain.value = 0.3;

                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);

                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + 1);
                } catch (error) {
                    console.warn('ìŠ¹ë¦¬ ì‚¬ìš´ë“œ ì¬ìƒ ì‹¤íŒ¨:', error);
                }
            }

            showResults(winner, isFinal) {
                document.getElementById('winnerText').textContent =
                    isFinal ? `ğŸ† ${winner} ìµœì¢… ìŠ¹ë¦¬!` : `ğŸ ${winner} ë¼ìš´ë“œ ìŠ¹ë¦¬!`;

                const statsHtml = this.generateRaceStats();
                document.getElementById('raceStats').innerHTML = statsHtml;

                this.elements.resultsPanel.classList.remove('hidden');
                this.elements.gameHUD.classList.add('hidden');
            }

            generateRaceStats() {
                const p1 = this.players.sensor1;
                const p2 = this.players.sensor2;

                return `
                    <div class="stat-row">
                        <span>Player 1 ë©:</span>
                        <span>${p1.lapCount}</span>
                    </div>
                    <div class="stat-row">
                        <span>Player 2 ë©:</span>
                        <span>${p2.lapCount}</span>
                    </div>
                    <div class="stat-row">
                        <span>Player 1 ìµœê³  ë©:</span>
                        <span>${this.formatTime(p1.bestLapTime)}</span>
                    </div>
                    <div class="stat-row">
                        <span>Player 2 ìµœê³  ë©:</span>
                        <span>${this.formatTime(p2.bestLapTime)}</span>
                    </div>
                    <div class="stat-row">
                        <span>ì´ ê²½ì£¼ ì‹œê°„:</span>
                        <span>${this.formatTime((Date.now() - this.raceStartTime) / 1000)}</span>
                    </div>
                    <div class="stat-row">
                        <span>ì„ íƒëœ íŠ¸ë™:</span>
                        <span>${this.tracks[this.selectedTrack].name}</span>
                    </div>
                `;
            }

            formatTime(seconds) {
                if (seconds === Infinity) return '--:--';
                const mins = Math.floor(seconds / 60);
                const secs = (seconds % 60).toFixed(2);
                return `${mins.toString().padStart(2, '0')}:${secs.padStart(5, '0')}`;
            }

            nextRace() {
                if (this.gameMode === 'best-of-3' && Math.max(...Object.values(this.raceWins)) < 2) {
                    this.currentRace++;
                    this.elements.resultsPanel.classList.add('hidden');
                    this.showTrackSelection();
                } else {
                    this.resetGame();
                }
            }

            resetGame() {
                this.gameState = 'mode-selection';
                this.raceWins = { sensor1: 0, sensor2: 0 };
                this.currentRace = 1;

                this.elements.resultsPanel.classList.add('hidden');
                this.elements.gameScreen.classList.add('hidden');
                this.elements.controlPanel.classList.add('hidden');
                this.elements.gameHUD.classList.add('hidden');
                this.elements.trackSelection.classList.add('hidden');
                this.elements.modeSelection.classList.remove('hidden');

                console.log('ğŸ”„ ê²Œì„ ì¬ì‹œì‘');
            }

            pauseGame() {
                if (this.gameState === 'racing') {
                    this.gameState = 'paused';
                    console.log('â¸ï¸ ê²Œì„ ì¼ì‹œì •ì§€');

                    alert('ì„¼ì„œ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì¬ì—°ê²°ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...');
                }
            }

            resumeGame() {
                if (this.gameState === 'paused' && this.connectedSensors.size >= 2) {
                    this.gameState = 'racing';
                    console.log('â–¶ï¸ ê²Œì„ ì¬ê°œ');
                }
            }
        }

        const game = new Racing3DGame();

        // ì „ì—­ ê°ì²´ë¡œ ë“±ë¡
        window.game = game;

        // ëª¨ë“œ ì„ íƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.addEventListener('click', (e) => {
            // ëª¨ë“œ ì„ íƒ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
            if (e.target.classList.contains('mode-btn')) {
                const mode = e.target.getAttribute('data-mode');
                console.log(`ëª¨ë“œ ë²„íŠ¼ í´ë¦­ë¨: ${mode}`);
                game.selectMode(mode);
                return;
            }

            // íŠ¸ë™ ì„ íƒ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
            if (e.target.closest('.track-btn')) {
                const trackBtn = e.target.closest('.track-btn');
                const onclick = trackBtn.getAttribute('onclick');
                if (onclick) {
                    const trackMatch = onclick.match(/'([^']+)'/);
                    if (trackMatch) {
                        const trackId = trackMatch[1];
                        console.log(`íŠ¸ë™ ë²„íŠ¼ í´ë¦­ë¨: ${trackId}`);
                        game.selectTrack(trackId);
                    }
                }
                return;
            }
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèéÔ∏è 3D Î†àÏù¥Ïã± Í≤åÏûÑ</title>
    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --background: #0f172a;
            --surface: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --border: #475569;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        /* Í≤åÏûÑ Ïª®ÌÖåÏù¥ÎÑà */
        .game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: linear-gradient(to bottom, #87CEEB 0%, #98FB98 100%);
        }

        /* ÌôîÎ©¥ Î∂ÑÌï† */
        .split-screen {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .viewport {
            flex: 1;
            position: relative;
            overflow: hidden;
            border-right: 2px solid #333;
            perspective: 1000px;
        }

        .viewport:last-child {
            border-right: none;
        }

        /* 3D Ìä∏Îûô */
        .track-3d {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
        }

        /* Ìä∏Îûô ÏÑ∏Í∑∏Î®ºÌä∏ */
        .track-segment {
            position: absolute;
            width: 100%;
            height: 200px;
            background: linear-gradient(to right,
                    #228B22 0%, #228B22 20%,
                    #666 20%, #666 80%,
                    #228B22 80%, #228B22 100%);
            border-bottom: 4px solid #fff;
            transform-style: preserve-3d;
        }

        /* ÏûêÎèôÏ∞® */
        .car {
            position: absolute;
            width: 40px;
            height: 80px;
            left: 50%;
            bottom: 100px;
            margin-left: -20px;
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out;
        }

        .car-body {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #ff4444, #cc0000);
            border-radius: 20px 20px 5px 5px;
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .car.player2 .car-body {
            background: linear-gradient(45deg, #4444ff, #0000cc);
        }

        .car-windshield {
            position: absolute;
            top: 10px;
            left: 5px;
            right: 5px;
            height: 30px;
            background: rgba(135, 206, 235, 0.8);
            border-radius: 15px 15px 0 0;
        }

        .car-wheels {
            position: absolute;
            width: 8px;
            height: 12px;
            background: #222;
            border-radius: 2px;
        }

        .wheel-fl {
            top: 15px;
            left: -4px;
        }

        .wheel-fr {
            top: 15px;
            right: -4px;
        }

        .wheel-bl {
            bottom: 15px;
            left: -4px;
        }

        .wheel-br {
            bottom: 15px;
            right: -4px;
        }

        /* UI Ïä§ÌÉÄÏùº */
        .game-ui {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 100;
        }

        .ui-panel {
            position: absolute;
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.25rem;
            backdrop-filter: blur(12px);
            pointer-events: all;
        }

        .session-panel {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            min-width: 400px;
        }

        .session-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .session-code {
            font-size: 3rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            color: var(--primary);
            margin: 1.5rem 0;
            padding: 1rem;
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid var(--primary);
            border-radius: 0.75rem;
            letter-spacing: 0.3em;
        }

        .qr-container {
            margin: 1.5rem 0;
            padding: 1rem;
            background: white;
            border-radius: 0.75rem;
            display: inline-block;
        }

        .control-panel {
            bottom: 1rem;
            left: 1rem;
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        /* HUD */
        .hud {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 50;
            pointer-events: none;
        }

        .player-hud {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            min-width: 200px;
            backdrop-filter: blur(8px);
        }

        .player-hud h3 {
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
            color: var(--primary);
        }

        .hud-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .hud-stat .label {
            color: var(--text-secondary);
        }

        .hud-stat .value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .hidden {
            display: none !important;
        }

        /* Í≤åÏûÑ Î™®Îìú ÏÑ†ÌÉù */
        .mode-selection {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            z-index: 200;
            backdrop-filter: blur(12px);
        }

        .mode-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: center;
        }

        .mode-btn {
            padding: 1rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .mode-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }

        /* Ìä∏Îûô ÏÑ†ÌÉù */
        .track-selection {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            z-index: 200;
            backdrop-filter: blur(12px);
        }

        .track-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .track-btn {
            padding: 1.5rem;
            background: var(--surface);
            color: var(--text-primary);
            border: 2px solid var(--border);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .track-btn:hover {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }

        .track-btn.selected {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.2);
        }

        .track-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .track-difficulty {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Í≤∞Í≥º ÌôîÎ©¥ */
        .results-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            z-index: 200;
            backdrop-filter: blur(12px);
            min-width: 400px;
        }

        .winner-text {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--success);
        }

        .race-stats {
            margin: 1.5rem 0;
            text-align: left;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.25rem;
        }
    </style>
</head>

<body>
    <div class="game-container">
        <!-- ÌôîÎ©¥ Î∂ÑÌï† -->
        <div class="split-screen hidden" id="gameScreen">
            <div class="viewport" id="viewport1">
                <div class="track-3d" id="track1">
                    <!-- ÌîåÎ†àÏù¥Ïñ¥ 1 ÏûêÎèôÏ∞® -->
                    <div class="car player1" id="car1">
                        <div class="car-body">
                            <div class="car-windshield"></div>
                            <div class="car-wheels wheel-fl"></div>
                            <div class="car-wheels wheel-fr"></div>
                            <div class="car-wheels wheel-bl"></div>
                            <div class="car-wheels wheel-br"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="viewport" id="viewport2">
                <div class="track-3d" id="track2">
                    <!-- ÌîåÎ†àÏù¥Ïñ¥ 2 ÏûêÎèôÏ∞® -->
                    <div class="car player2" id="car2">
                        <div class="car-body">
                            <div class="car-windshield"></div>
                            <div class="car-wheels wheel-fl"></div>
                            <div class="car-wheels wheel-fr"></div>
                            <div class="car-wheels wheel-bl"></div>
                            <div class="car-wheels wheel-br"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Í≤åÏûÑ UI -->
    <div class="game-ui">
        <!-- ÏÑ∏ÏÖò ÎåÄÍ∏∞ Ìå®ÎÑê -->
        <div class="ui-panel session-panel" id="sessionPanel">
            <div class="session-title">üèéÔ∏è 3D Î†àÏù¥Ïã± Í≤åÏûÑ</div>
            <div style="color: var(--text-secondary); margin-bottom: 1.5rem; line-height: 1.6;">
                Îëê Î™ÖÏù¥ Ìï®Íªò Ï¶êÍ∏∞Îäî 3D Î†àÏù¥Ïã± Í≤ΩÏüÅ!<br>
                ÌôîÎ©¥ Î∂ÑÌï†Î°ú Í∞ÅÏûêÏùò ÏãúÏ†êÏóêÏÑú Í≤ΩÏ£ºÌïòÏÑ∏Ïöî
            </div>

            <div class="session-code" id="sessionCode">----</div>

            <div class="qr-container" id="qrContainer">
                <div style="color: #666; padding: 2rem;">QR ÏΩîÎìú ÏÉùÏÑ± Ï§ë...</div>
            </div>

            <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 1rem;">
                üì± Î™®Î∞îÏùºÎ°ú QR ÏΩîÎìúÎ•º Ïä§Ï∫îÌïòÍ±∞ÎÇò<br>
                ÏÑºÏÑú ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú ÏÑ∏ÏÖò ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî<br><br>
                <strong>Ï°∞ÏûëÎ≤ï:</strong><br>
                Ï¢åÏö∞ Í∏∞Ïö∏Í∏∞ ‚Üí Ìï∏Îì§ Ï°∞Ïûë<br>
                ÏïûÎí§ Í∏∞Ïö∏Í∏∞ ‚Üí Í∞ÄÏÜç/Î∏åÎ†àÏù¥ÌÅ¨<br>
                <strong>ÌÖåÏä§Ìä∏:</strong> ÌÇ§Î≥¥Îìú WASD / ÌôîÏÇ¥ÌëúÌÇ§
            </div>
        </div>

        <!-- Í≤åÏûÑ Î™®Îìú ÏÑ†ÌÉù -->
        <div class="mode-selection hidden" id="modeSelection">
            <h2>Í≤åÏûÑ Î™®Îìú ÏÑ†ÌÉù</h2>
            <p style="color: var(--text-secondary); margin: 1rem 0;">
                ÏõêÌïòÎäî Í≤ΩÏ£º Î™®ÎìúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî
            </p>
            <div class="mode-buttons">
                <button class="mode-btn" data-mode="quick">
                    üèÅ Îπ†Î•∏ Í≤ΩÏ£º<br>
                    <small>3Îû© Í≤ΩÏ£º</small>
                </button>
                <button class="mode-btn" data-mode="best-of-3">
                    üèÜ Î≤†Ïä§Ìä∏ Ïò§Î∏å 3<br>
                    <small>3Ï†Ñ 2Ïäπ</small>
                </button>
                <button class="mode-btn" data-mode="time-attack">
                    ‚è±Ô∏è ÌÉÄÏûÑ Ïñ¥ÌÉù<br>
                    <small>Ï†úÌïúÏãúÍ∞Ñ Í≤ΩÏ£º</small>
                </button>
            </div>
        </div>

        <!-- Ìä∏Îûô ÏÑ†ÌÉù -->
        <div class="track-selection hidden" id="trackSelection">
            <h2>Ìä∏Îûô ÏÑ†ÌÉù</h2>
            <p style="color: var(--text-secondary); margin: 1rem 0;">
                Í≤ΩÏ£ºÌï† Ìä∏ÎûôÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî
            </p>
            <div class="track-buttons">
                <div class="track-btn" onclick="game.selectTrack('speedway')">
                    <div class="track-name">üèÅ Ïä§ÌîºÎìúÏõ®Ïù¥</div>
                    <div class="track-difficulty">ÎÇúÏù¥ÎèÑ: Ïâ¨ÏõÄ</div>
                </div>
                <div class="track-btn" onclick="game.selectTrack('mountain')">
                    <div class="track-name">üèîÔ∏è ÏÇ∞ÏïÖ ÏΩîÏä§</div>
                    <div class="track-difficulty">ÎÇúÏù¥ÎèÑ: Î≥¥ÌÜµ</div>
                </div>
                <div class="track-btn" onclick="game.selectTrack('city')">
                    <div class="track-name">üèôÔ∏è ÎèÑÏã¨ ÏÑúÌÇ∑</div>
                    <div class="track-difficulty">ÎÇúÏù¥ÎèÑ: Ïñ¥Î†§ÏõÄ</div>
                </div>
            </div>
            <div style="margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="game.startRaceWithTrack()">Í≤ΩÏ£º ÏãúÏûë</button>
            </div>
        </div>

        <!-- Ïª®Ìä∏Î°§ Ìå®ÎÑê -->
        <div class="ui-panel control-panel hidden" id="controlPanel">
            <button class="btn btn-secondary" onclick="game.resetGame()">üîÑ Ïû¨ÏãúÏûë</button>
            <button class="btn btn-secondary" onclick="game.pauseGame()">‚è∏Ô∏è ÏùºÏãúÏ†ïÏßÄ</button>
            <a href="/" class="btn btn-secondary">üè† ÌóàÎ∏åÎ°ú</a>
        </div>

        <!-- HUD -->
        <div class="hud hidden" id="gameHUD">
            <div class="player-hud">
                <h3>Player 1 üî¥</h3>
                <div class="hud-stat">
                    <span class="label">ÏÜçÎèÑ:</span>
                    <span class="value" id="p1Speed">0 km/h</span>
                </div>
                <div class="hud-stat">
                    <span class="label">Îû©:</span>
                    <span class="value" id="p1Lap">0/3</span>
                </div>
                <div class="hud-stat">
                    <span class="label">ÏãúÍ∞Ñ:</span>
                    <span class="value" id="p1Time">00:00</span>
                </div>
                <div class="hud-stat">
                    <span class="label">ÏàúÏúÑ:</span>
                    <span class="value" id="p1Rank">-</span>
                </div>
            </div>

            <div class="player-hud">
                <h3>Player 2 üîµ</h3>
                <div class="hud-stat">
                    <span class="label">ÏÜçÎèÑ:</span>
                    <span class="value" id="p2Speed">0 km/h</span>
                </div>
                <div class="hud-stat">
                    <span class="label">Îû©:</span>
                    <span class="value" id="p2Lap">0/3</span>
                </div>
                <div class="hud-stat">
                    <span class="label">ÏãúÍ∞Ñ:</span>
                    <span class="value" id="p2Time">00:00</span>
                </div>
                <div class="hud-stat">
                    <span class="label">ÏàúÏúÑ:</span>
                    <span class="value" id="p2Rank">-</span>
                </div>
            </div>
        </div>

        <!-- Í≤∞Í≥º Ìå®ÎÑê -->
        <div class="results-panel hidden" id="resultsPanel">
            <div class="winner-text" id="winnerText">üèÜ Player 1 ÏäπÎ¶¨!</div>
            <div class="race-stats" id="raceStats">
                <!-- Í≤ΩÏ£º Í≤∞Í≥º ÌÜµÍ≥Ñ -->
            </div>
            <div style="margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="game.nextRace()">Îã§Ïùå Í≤ΩÏ£º</button>
                <button class="btn btn-secondary" onclick="game.resetGame()">ÏÉà Í≤åÏûÑ</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="/js/SessionSDK.js"></script>

    <script>
        class Racing3DGame {
            constructor() {
                this.sdk = new SessionSDK({
                    gameId: 'racing-3d',
                    gameType: 'dual',
                    debug: true
                });

                this.gameState = 'waiting';
                this.gameMode = null;
                this.connectedSensors = new Set();

                this.players = {
                    sensor1: {
                        connected: false,
                        car: document.getElementById('car1'),
                        track: document.getElementById('track1'),
                        position: { x: 0, y: 0, z: 0 },
                        velocity: { x: 0, y: 0, z: 0 },
                        rotation: 0,
                        speed: 0,
                        steering: 0,
                        acceleration: 0,
                        lapCount: 0,
                        lapTime: 0,
                        totalTime: 0,
                        bestLapTime: Infinity,
                        rank: 1,
                        trackOffset: 0
                    },
                    sensor2: {
                        connected: false,
                        car: document.getElementById('car2'),
                        track: document.getElementById('track2'),
                        position: { x: 0, y: 0, z: 0 },
                        velocity: { x: 0, y: 0, z: 0 },
                        rotation: 0,
                        speed: 0,
                        steering: 0,
                        acceleration: 0,
                        lapCount: 0,
                        lapTime: 0,
                        totalTime: 0,
                        bestLapTime: Infinity,
                        rank: 2,
                        trackOffset: 0
                    }
                };

                this.gameModes = {
                    'quick': { laps: 3, description: 'Îπ†Î•∏ Í≤ΩÏ£º' },
                    'best-of-3': { races: 3, wins: 2, description: 'Î≤†Ïä§Ìä∏ Ïò§Î∏å 3' },
                    'time-attack': { timeLimit: 120, description: 'ÌÉÄÏûÑ Ïñ¥ÌÉù' }
                };

                this.raceStartTime = 0;
                this.raceWins = { sensor1: 0, sensor2: 0 };
                this.currentRace = 1;

                this.elements = {
                    sessionPanel: document.getElementById('sessionPanel'),
                    modeSelection: document.getElementById('modeSelection'),
                    trackSelection: document.getElementById('trackSelection'),
                    gameScreen: document.getElementById('gameScreen'),
                    controlPanel: document.getElementById('controlPanel'),
                    gameHUD: document.getElementById('gameHUD'),
                    resultsPanel: document.getElementById('resultsPanel'),
                    sessionCode: document.getElementById('sessionCode'),
                    qrContainer: document.getElementById('qrContainer')
                };

                this.tracks = {
                    'speedway': { name: 'üèÅ Ïä§ÌîºÎìúÏõ®Ïù¥', difficulty: 'Ïâ¨ÏõÄ', friction: 0.95, maxSpeed: 1.2 },
                    'mountain': { name: 'üèîÔ∏è ÏÇ∞ÏïÖ ÏΩîÏä§', difficulty: 'Î≥¥ÌÜµ', friction: 0.90, maxSpeed: 1.0 },
                    'city': { name: 'üèôÔ∏è ÎèÑÏã¨ ÏÑúÌÇ∑', difficulty: 'Ïñ¥Î†§ÏõÄ', friction: 0.85, maxSpeed: 0.8 }
                };
                this.selectedTrack = 'speedway';

                this.audioContext = null;
                this.audioEnabled = false;
                this.initAudio();

                this.setupEventListeners();
                this.generateTrackSegments();
                this.startGameLoop();

                console.log('üèéÔ∏è 3D Î†àÏù¥Ïã± Í≤åÏûÑ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
            }

            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.audioEnabled = true;
                    console.log('üîä Ïò§ÎîîÏò§ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
                } catch (error) {
                    console.warn('Ïò§ÎîîÏò§ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                    this.audioEnabled = false;
                }
            }

            setupEventListeners() {
                this.sdk.on('connected', () => {
                    console.log('‚úÖ ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏôÑÎ£å');
                    this.createSession();
                });

                this.sdk.on('session-created', (event) => {
                    const session = event.detail || event;
                    console.log('‚úÖ ÏÑ∏ÏÖò ÏÉùÏÑ±:', session.sessionCode);
                    this.elements.sessionCode.textContent = session.sessionCode;
                    this.generateQRCode(session.sessionCode);
                });

                this.sdk.on('sensor-connected', (event) => {
                    const data = event.detail || event;
                    this.handleSensorConnected(data.sensorId);
                });

                this.sdk.on('sensor-data', (event) => {
                    const data = event.detail || event;
                    this.handleSensorData(data);
                });

                this.sdk.on('sensor-disconnected', (event) => {
                    const data = event.detail || event;
                    this.handleSensorDisconnected(data.sensorId);
                });

                this.setupKeyboardControls();
            }

            setupKeyboardControls() {
                const keys = {};

                document.addEventListener('keydown', (event) => {
                    keys[event.key] = true;
                    if (this.gameState === 'racing') {
                        this.handleKeyboardInput(keys);
                    }
                });

                document.addEventListener('keyup', (event) => {
                    keys[event.key] = false;
                    if (this.gameState === 'racing') {
                        this.handleKeyboardInput(keys);
                    }
                });

                this.keyboardKeys = keys;
            }

            handleKeyboardInput(keys) {
                let p1Steering = 0, p1Acceleration = 0;
                if (keys['a'] || keys['A']) p1Steering = -1;
                if (keys['d'] || keys['D']) p1Steering = 1;
                if (keys['w'] || keys['W']) p1Acceleration = 1;
                if (keys['s'] || keys['S']) p1Acceleration = -0.5;

                this.updateCarInput('sensor1', p1Steering, p1Acceleration);

                let p2Steering = 0, p2Acceleration = 0;
                if (keys['ArrowLeft']) p2Steering = -1;
                if (keys['ArrowRight']) p2Steering = 1;
                if (keys['ArrowUp']) p2Acceleration = 1;
                if (keys['ArrowDown']) p2Acceleration = -0.5;

                this.updateCarInput('sensor2', p2Steering, p2Acceleration);
            }

            async createSession() {
                try {
                    await this.sdk.createSession();
                } catch (error) {
                    console.error('ÏÑ∏ÏÖò ÏÉùÏÑ± Ïã§Ìå®:', error);
                }
            }

            generateQRCode(sessionCode) {
                const qrUrl = `${window.location.origin}/sensor.html?session=${sessionCode}`;

                if (typeof QRCode !== 'undefined') {
                    QRCode.toCanvas(document.createElement('canvas'), qrUrl, (error, canvas) => {
                        if (!error) {
                            canvas.style.width = '200px';
                            canvas.style.height = '200px';
                            this.elements.qrContainer.innerHTML = '';
                            this.elements.qrContainer.appendChild(canvas);
                        } else {
                            console.error('QR ÏΩîÎìú ÏÉùÏÑ± Ïã§Ìå®:', error);
                            this.showQRCodeFallback(qrUrl);
                        }
                    });
                } else {
                    console.warn('QRCode ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ìè¥Î∞± ÏÇ¨Ïö©.');
                    this.showQRCodeFallback(qrUrl);
                }
            }

            showQRCodeFallback(qrUrl) {
                const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrUrl)}`;
                const img = document.createElement('img');
                img.src = qrApiUrl;
                img.style.width = '200px';
                img.style.height = '200px';
                img.alt = 'QR Code';

                this.elements.qrContainer.innerHTML = '';
                this.elements.qrContainer.appendChild(img);
            }

            handleSensorConnected(sensorId) {
                this.connectedSensors.add(sensorId);
                this.players[sensorId].connected = true;

                console.log(`‚úÖ ${sensorId} ÏÑºÏÑú Ïó∞Í≤∞Îê®`);
                console.log(`Ïó∞Í≤∞Îêú ÏÑºÏÑú Ïàò: ${this.connectedSensors.size}`);

                if (this.connectedSensors.size >= 2) {
                    console.log('üéÆ Î™®Îì† ÏÑºÏÑú Ïó∞Í≤∞ ÏôÑÎ£å, Î™®Îìú ÏÑ†ÌÉù ÌôîÎ©¥ ÌëúÏãú');
                    setTimeout(() => {
                        this.showModeSelection();
                    }, 500);
                }
            }

            handleSensorDisconnected(sensorId) {
                this.connectedSensors.delete(sensorId);
                this.players[sensorId].connected = false;

                console.log(`‚ö†Ô∏è ${sensorId} ÏÑºÏÑú Ïó∞Í≤∞ Ìï¥Ï†ú`);

                if (this.gameState === 'racing') {
                    this.pauseGame();
                }
            }

            handleSensorData(data) {
                const { sensorId, data: sensorData } = data;

                if (!sensorData || !sensorData.orientation) return;

                const { orientation } = sensorData;
                const { beta, gamma } = orientation;

                let steering = Math.max(-1, Math.min(1, gamma * 0.03));
                let acceleration = 0;

                if (beta < -15) acceleration = 1;
                else if (beta > 15) acceleration = -0.5;

                this.updateCarInput(sensorId, steering, acceleration);
            }

            updateCarInput(sensorId, steering, acceleration) {
                const player = this.players[sensorId];
                if (!player || !player.connected) return;

                player.steering = steering;
                player.acceleration = acceleration;
            }

            showModeSelection() {
                console.log('üéÆ showModeSelection Ìò∏Ï∂úÎê®');
                this.gameState = 'mode-selection';

                console.log('ÏÑ∏ÏÖò Ìå®ÎÑê Ïà®Í∏∞Í∏∞');
                this.elements.sessionPanel.classList.add('hidden');

                console.log('Î™®Îìú ÏÑ†ÌÉù Ìå®ÎÑê ÌëúÏãú');
                this.elements.modeSelection.classList.remove('hidden');

                console.log('Î™®Îìú ÏÑ†ÌÉù ÌôîÎ©¥ ÌëúÏãú ÏôÑÎ£å');
            }

            selectMode(mode) {
                console.log(`üéØ selectMode Ìò∏Ï∂úÎê®: ${mode}`);
                this.gameMode = mode;
                this.elements.modeSelection.classList.add('hidden');
                this.showTrackSelection();
            }

            showTrackSelection() {
                this.elements.trackSelection.classList.remove('hidden');

                document.querySelectorAll('.track-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                document.querySelector('.track-btn').classList.add('selected');
            }

            selectTrack(trackId) {
                this.selectedTrack = trackId;

                document.querySelectorAll('.track-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                event.target.closest('.track-btn').classList.add('selected');
            }

            startRaceWithTrack() {
                this.elements.trackSelection.classList.add('hidden');
                this.startRace();
            }

            startRace() {
                this.gameState = 'racing';
                this.raceStartTime = Date.now();

                this.elements.gameScreen.classList.remove('hidden');
                this.elements.controlPanel.classList.remove('hidden');
                this.elements.gameHUD.classList.remove('hidden');

                Object.values(this.players).forEach(player => {
                    player.position = { x: 0, y: 0, z: 0 };
                    player.velocity = { x: 0, y: 0, z: 0 };
                    player.rotation = 0;
                    player.speed = 0;
                    player.lapCount = 0;
                    player.lapTime = 0;
                    player.totalTime = 0;
                    player.trackOffset = 0;
                });

                console.log(`üèÅ ${this.gameModes[this.gameMode].description} ÏãúÏûë! Ìä∏Îûô: ${this.tracks[this.selectedTrack].name}`);
            }

            generateTrackSegments() {
                ['track1', 'track2'].forEach(trackId => {
                    const track = document.getElementById(trackId);

                    for (let i = 0; i < 20; i++) {
                        const segment = document.createElement('div');
                        segment.className = 'track-segment';
                        segment.style.transform = `translateZ(${-i * 200}px)`;
                        track.appendChild(segment);
                    }
                });
            }

            startGameLoop() {
                const gameLoop = () => {
                    if (this.gameState === 'racing') {
                        this.updatePhysics();
                        this.updateCars();
                        this.updateTracks();
                        this.updateHUD();
                        this.checkRaceConditions();
                    }

                    requestAnimationFrame(gameLoop);
                };

                gameLoop();
            }

            updatePhysics() {
                Object.entries(this.players).forEach(([sensorId, player]) => {
                    if (!player.connected) return;

                    const trackSettings = this.tracks[this.selectedTrack];

                    const forwardX = Math.sin(player.rotation * Math.PI / 180);
                    const forwardZ = Math.cos(player.rotation * Math.PI / 180);

                    if (player.acceleration !== 0) {
                        const maxAccel = trackSettings.maxSpeed * 0.3;
                        player.velocity.x += forwardX * player.acceleration * maxAccel;
                        player.velocity.z += forwardZ * player.acceleration * maxAccel;
                    }

                    if (Math.abs(player.steering) > 0.01 && Math.abs(player.speed) > 0.1) {
                        player.rotation += player.steering * player.speed * 1.5;
                    }

                    player.velocity.x *= trackSettings.friction;
                    player.velocity.z *= trackSettings.friction;

                    player.position.x += player.velocity.x;
                    player.position.z += player.velocity.z;

                    player.speed = Math.sqrt(player.velocity.x ** 2 + player.velocity.z ** 2);

                    if (Math.abs(player.position.x) > 150) {
                        player.velocity.x *= 0.7;
                        player.position.x = Math.sign(player.position.x) * 150;
                        this.showOffRoadWarning(sensorId);
                    }

                    player.trackOffset += player.speed * 2;

                    if (player.speed > 0.1) {
                        this.playEngineSound(sensorId, player.speed);
                    }

                    const lapDistance = 5000;
                    const newLapCount = Math.floor(player.trackOffset / lapDistance);
                    if (newLapCount > player.lapCount) {
                        player.lapCount = newLapCount;
                        const currentTime = (Date.now() - this.raceStartTime) / 1000;
                        const lapTime = currentTime - player.totalTime;
                        player.lapTime = lapTime;
                        player.totalTime = currentTime;

                        if (lapTime < player.bestLapTime) {
                            player.bestLapTime = lapTime;
                        }

                        console.log(`üèÅ ${sensorId} Îû© ${player.lapCount} ÏôÑÏ£º! ÏãúÍ∞Ñ: ${lapTime.toFixed(2)}Ï¥à`);
                    }
                });
            }

            playEngineSound(sensorId, speed) {
                if (!this.audioEnabled || !this.audioContext) return;

                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    const panNode = this.audioContext.createStereoPanner();

                    panNode.pan.value = sensorId === 'sensor1' ? -0.7 : 0.7;

                    oscillator.frequency.value = 100 + speed * 20;
                    gainNode.gain.value = Math.min(0.1, speed * 0.02);

                    oscillator.connect(gainNode);
                    gainNode.connect(panNode);
                    panNode.connect(this.audioContext.destination);

                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + 0.1);
                } catch (error) {
                    console.warn('ÏóîÏßÑ ÏÇ¨Ïö¥Îìú Ïû¨ÏÉù Ïã§Ìå®:', error);
                }
            }

            showOffRoadWarning(sensorId) {
                const playerNum = sensorId === 'sensor1' ? 1 : 2;
                const viewport = document.getElementById(`viewport${playerNum}`);

                viewport.style.filter = 'sepia(0.3) saturate(1.5)';
                setTimeout(() => {
                    viewport.style.filter = '';
                }, 500);
            }

            updateCars() {
                Object.values(this.players).forEach(player => {
                    if (!player.car) return;

                    const transform = `
                        translateX(${player.position.x}px)
                        translateZ(${player.position.z}px)
                        rotateY(${player.rotation}deg)
                    `;

                    player.car.style.transform = transform;
                });
            }

            updateTracks() {
                Object.entries(this.players).forEach(([sensorId, player]) => {
                    if (!player.track) return;

                    const trackTransform = `
                        translateZ(${player.trackOffset}px)
                        rotateY(${-player.rotation}deg)
                    `;

                    player.track.style.transform = trackTransform;
                });
            }

            updateHUD() {
                Object.entries(this.players).forEach(([sensorId, player], index) => {
                    const playerNum = index + 1;
                    const speedKmh = Math.round(player.speed * 10);
                    const currentTime = (Date.now() - this.raceStartTime) / 1000;

                    document.getElementById(`p${playerNum}Speed`).textContent = `${speedKmh} km/h`;
                    document.getElementById(`p${playerNum}Lap`).textContent = `${player.lapCount}/${this.gameModes[this.gameMode]?.laps || 3}`;
                    document.getElementById(`p${playerNum}Time`).textContent = this.formatTime(currentTime);

                    const ranks = this.calculateRanks();
                    document.getElementById(`p${playerNum}Rank`).textContent = ranks[sensorId];
                });
            }

            calculateRanks() {
                const players = Object.entries(this.players);
                players.sort((a, b) => {
                    const [, playerA] = a;
                    const [, playerB] = b;

                    if (playerA.lapCount !== playerB.lapCount) {
                        return playerB.lapCount - playerA.lapCount;
                    }

                    return playerB.trackOffset - playerA.trackOffset;
                });

                const ranks = {};
                players.forEach(([sensorId], index) => {
                    ranks[sensorId] = index + 1;
                });

                return ranks;
            }

            checkRaceConditions() {
                const targetLaps = this.gameModes[this.gameMode]?.laps || 3;

                Object.entries(this.players).forEach(([sensorId, player]) => {
                    if (player.lapCount >= targetLaps) {
                        this.finishRace(sensorId);
                    }
                });

                if (this.gameMode === 'time-attack') {
                    const elapsed = (Date.now() - this.raceStartTime) / 1000;
                    if (elapsed >= this.gameModes['time-attack'].timeLimit) {
                        this.finishTimeAttack();
                    }
                }
            }

            finishRace(winnerId) {
                this.gameState = 'finished';

                const winner = winnerId === 'sensor1' ? 'Player 1' : 'Player 2';

                this.playVictorySound();

                if (this.gameMode === 'best-of-3') {
                    this.raceWins[winnerId]++;

                    if (this.raceWins[winnerId] >= 2) {
                        this.showResults(winner, true);
                    } else {
                        this.showResults(winner, false);
                    }
                } else {
                    this.showResults(winner, true);
                }
            }

            finishTimeAttack() {
                const p1Laps = this.players.sensor1.lapCount;
                const p2Laps = this.players.sensor2.lapCount;

                let winner;
                if (p1Laps > p2Laps) winner = 'Player 1';
                else if (p2Laps > p1Laps) winner = 'Player 2';
                else winner = 'Î¨¥ÏäπÎ∂Ä';

                this.playVictorySound();
                this.showResults(winner, true);
            }

            playVictorySound() {
                if (!this.audioEnabled || !this.audioContext) return;

                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();

                    oscillator.frequency.value = 523;
                    gainNode.gain.value = 0.3;

                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);

                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + 1);
                } catch (error) {
                    console.warn('ÏäπÎ¶¨ ÏÇ¨Ïö¥Îìú Ïû¨ÏÉù Ïã§Ìå®:', error);
                }
            }

            showResults(winner, isFinal) {
                document.getElementById('winnerText').textContent =
                    isFinal ? `üèÜ ${winner} ÏµúÏ¢Ö ÏäπÎ¶¨!` : `üèÅ ${winner} ÎùºÏö¥Îìú ÏäπÎ¶¨!`;

                const statsHtml = this.generateRaceStats();
                document.getElementById('raceStats').innerHTML = statsHtml;

                this.elements.resultsPanel.classList.remove('hidden');
                this.elements.gameHUD.classList.add('hidden');
            }

            generateRaceStats() {
                const p1 = this.players.sensor1;
                const p2 = this.players.sensor2;

                return `
                    <div class="stat-row">
                        <span>Player 1 Îû©:</span>
                        <span>${p1.lapCount}</span>
                    </div>
                    <div class="stat-row">
                        <span>Player 2 Îû©:</span>
                        <span>${p2.lapCount}</span>
                    </div>
                    <div class="stat-row">
                        <span>Player 1 ÏµúÍ≥† Îû©:</span>
                        <span>${this.formatTime(p1.bestLapTime)}</span>
                    </div>
                    <div class="stat-row">
                        <span>Player 2 ÏµúÍ≥† Îû©:</span>
                        <span>${this.formatTime(p2.bestLapTime)}</span>
                    </div>
                    <div class="stat-row">
                        <span>Ï¥ù Í≤ΩÏ£º ÏãúÍ∞Ñ:</span>
                        <span>${this.formatTime((Date.now() - this.raceStartTime) / 1000)}</span>
                    </div>
                    <div class="stat-row">
                        <span>ÏÑ†ÌÉùÎêú Ìä∏Îûô:</span>
                        <span>${this.tracks[this.selectedTrack].name}</span>
                    </div>
                `;
            }

            formatTime(seconds) {
                if (seconds === Infinity) return '--:--';
                const mins = Math.floor(seconds / 60);
                const secs = (seconds % 60).toFixed(2);
                return `${mins.toString().padStart(2, '0')}:${secs.padStart(5, '0')}`;
            }

            nextRace() {
                if (this.gameMode === 'best-of-3' && Math.max(...Object.values(this.raceWins)) < 2) {
                    this.currentRace++;
                    this.elements.resultsPanel.classList.add('hidden');
                    this.showTrackSelection();
                } else {
                    this.resetGame();
                }
            }

            resetGame() {
                this.gameState = 'mode-selection';
                this.raceWins = { sensor1: 0, sensor2: 0 };
                this.currentRace = 1;

                this.elements.resultsPanel.classList.add('hidden');
                this.elements.gameScreen.classList.add('hidden');
                this.elements.controlPanel.classList.add('hidden');
                this.elements.gameHUD.classList.add('hidden');
                this.elements.trackSelection.classList.add('hidden');
                this.elements.modeSelection.classList.remove('hidden');

                console.log('üîÑ Í≤åÏûÑ Ïû¨ÏãúÏûë');
            }

            pauseGame() {
                if (this.gameState === 'racing') {
                    this.gameState = 'paused';
                    console.log('‚è∏Ô∏è Í≤åÏûÑ ÏùºÏãúÏ†ïÏßÄ');

                    alert('ÏÑºÏÑú Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§. Ïû¨Ïó∞Í≤∞ÏùÑ Í∏∞Îã§Î¶¨Îäî Ï§ë...');
                }
            }

            resumeGame() {
                if (this.gameState === 'paused' && this.connectedSensors.size >= 2) {
                    this.gameState = 'racing';
                    console.log('‚ñ∂Ô∏è Í≤åÏûÑ Ïû¨Í∞ú');
                }
            }
        }

        const game = new Racing3DGame();

        // Ï†ÑÏó≠ Í∞ùÏ≤¥Î°ú Îì±Î°ù
        window.game = game;

        // Î™®Îìú ÏÑ†ÌÉù Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
        document.addEventListener('click', (e) => {
            // Î™®Îìú ÏÑ†ÌÉù Î≤ÑÌäº ÌÅ¥Î¶≠ Ï≤òÎ¶¨
            if (e.target.classList.contains('mode-btn')) {
                const mode = e.target.getAttribute('data-mode');
                console.log(`Î™®Îìú Î≤ÑÌäº ÌÅ¥Î¶≠Îê®: ${mode}`);
                game.selectMode(mode);
                return;
            }

            // Ìä∏Îûô ÏÑ†ÌÉù Î≤ÑÌäº ÌÅ¥Î¶≠ Ï≤òÎ¶¨
            if (e.target.closest('.track-btn')) {
                const trackBtn = e.target.closest('.track-btn');
                const onclick = trackBtn.getAttribute('onclick');
                if (onclick) {
                    const trackMatch = onclick.match(/'([^']+)'/);
                    if (trackMatch) {
                        const trackId = trackMatch[1];
                        console.log(`Ìä∏Îûô Î≤ÑÌäº ÌÅ¥Î¶≠Îê®: ${trackId}`);
                        game.selectTrack(trackId);
                    }
                }
                return;
            }
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>틸트 아케이드 게임</title>
    <link rel="stylesheet" href="/css/theme.css">
    <script src="/js/SessionSDK.js"></script>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas"></canvas>
        <div class="game-ui">
            <div class="session-panel">
                <div class="session-code">세션 코드: <span id="sessionCode"></span></div>
                <div class="qr-code">
                    <div id="qrCode"></div>
                </div>
            </div>
            <div class="game-info">
                <div class="score">점수: <span id="scoreDisplay">0</span></div>
                <div class="timer">시간: <span id="timerDisplay">0</span>s</div>
            </div>
            <div class="game-controls">
                <button id="restartButton">다시 시작</button>
                <button id="pauseButton">일시정지</button>
                <a href="/" class="home-button">허브로 돌아가기</a>
            </div>
        </div>
    </div>

    <script>
        // 세션 SDK 초기화
        const sessionSDK = new SessionSDK();

        // 게임 상태 변수
        let isGameRunning = false;
        let score = 0;
        let timer = 0;
        let targetX, targetY;
        let targetRadius = 50;

        // 캔버스 설정
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 800;
        canvas.height = 600;

        // 세션 생성 및 UI 업데이트
        sessionSDK.on('connected', () => {
            sessionSDK.createSession();
            updateSessionUI();
            startGame();
        });

        // 세션 UI 업데이트
        function updateSessionUI() {
            document.getElementById('sessionCode').textContent = sessionSDK.sessionCode;
            new QRCode(document.getElementById('qrCode'), {
                text: sessionSDK.sessionCode,
                width: 128,
                height: 128,
                correctLevel: QRCode.CorrectLevel.L
            });
        }

        // 게임 시작
        function startGame() {
            isGameRunning = true;
            spawnTarget();
            updateTimer();
            requestAnimationFrame(gameLoop);
        }

        // 타겟 생성
        function spawnTarget() {
            targetX = Math.floor(Math.random() * (canvas.width - targetRadius * 2)) + targetRadius;
            targetY = Math.floor(Math.random() * (canvas.height - targetRadius * 2)) + targetRadius;
        }

        // 게임 루프
        function gameLoop(timestamp) {
            if (!isGameRunning) return;

            // 화면 클리어
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 타겟 그리기
            ctx.beginPath();
            ctx.arc(targetX, targetY, targetRadius, 0, 2 * Math.PI);
            ctx.fillStyle = 'var(--primary)';
            ctx.fill();

            // 센서 데이터 처리
            sessionSDK.on('orientation', (event) => {
                const { beta, gamma } = (event.detail || event).data.orientation;
                const cursorX = canvas.width / 2 + gamma * 5;
                const cursorY = canvas.height / 2 + beta * 5;

                // 타겟 충돌 체크
                if (
                    Math.sqrt(Math.pow(cursorX - targetX, 2) + Math.pow(cursorY - targetY, 2)) <= targetRadius
                ) {
                    score++;
                    document.getElementById('scoreDisplay').textContent = score;
                    spawnTarget();
                }

                // 커서 그리기
                ctx.beginPath();
                ctx.arc(cursorX, cursorY, 20, 0, 2 * Math.PI);
                ctx.fillStyle = 'var(--secondary)';
                ctx.fill();
            });

            // 타이머 업데이트
            updateTimer();

            requestAnimationFrame(gameLoop);
        }

        // 타이머 업데이트
        function updateTimer() {
            timer++;
            document.getElementById('timerDisplay').textContent = timer;
        }

        // 버튼 이벤트 핸들러
        document.getElementById('restartButton').addEventListener('click', () => {
            score = 0;
            timer = 0;
            document.getElementById('scoreDisplay').textContent = score;
            document.getElementById('timerDisplay').textContent = timer;
            startGame();
        });

        document.getElementById('pauseButton').addEventListener('click', () => {
            isGameRunning = !isGameRunning;
            if (isGameRunning) {
                startGame();
            }
        });
    </script>
</body>
</html>
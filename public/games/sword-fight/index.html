<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öîÔ∏è Sword Fight - Sensor Game Hub</title>
    <style>
        :root {
            --primary: #dc2626;
            --secondary: #7c2d12;
            --success: #16a34a;
            --warning: #d97706;
            --error: #ef4444;
            --background: #0f0f0f;
            --surface: #1a1a1a;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --accent: #f59e0b;
            --sword-silver: #e5e7eb;
            --sword-gold: #fbbf24;
            --blood-red: #991b1b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--background), var(--surface));
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Î∞∞Í≤Ω Ìö®Í≥º */
        .background-effects {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .ember {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--accent);
            border-radius: 50%;
            animation: ember-rise 8s ease-out infinite;
        }

        @keyframes ember-rise {
            0% { 
                opacity: 1; 
                transform: translateY(0) scale(1) rotate(0deg);
                background: var(--accent);
            }
            50% {
                opacity: 0.8;
                background: var(--primary);
            }
            100% { 
                opacity: 0; 
                transform: translateY(-200px) scale(0.3) rotate(360deg);
                background: var(--blood-red);
            }
        }

        /* ÏÉÅÎã® UI */
        .game-header {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            text-align: center;
        }

        .session-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.6rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(220, 38, 38, 0.5);
        }

        .session-info {
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(220, 38, 38, 0.3);
            border-radius: 1rem;
            padding: 1rem;
            display: inline-block;
            max-width: 280px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .session-code {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 0.6rem;
            letter-spacing: 0.2em;
            text-align: center;
            text-shadow: 0 0 15px rgba(220, 38, 38, 0.5);
        }

        .qr-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .qr-container canvas,
        .qr-container img {
            background: white;
            border-radius: 0.5rem;
            padding: 0.3rem;
            width: 130px !important;
            height: 130px !important;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .connection-status {
            display: flex;
            justify-content: space-between;
            gap: 0.8rem;
            margin-top: 0.8rem;
        }

        .sensor-status {
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.7rem;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
        }

        .sensor-disconnected {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .sensor-connected {
            background: rgba(22, 163, 74, 0.2);
            border: 1px solid var(--success);
            color: var(--success);
            animation: pulse-success 2s infinite;
        }

        @keyframes pulse-success {
            0%, 100% { box-shadow: 0 0 5px rgba(22, 163, 74, 0.3); }
            50% { box-shadow: 0 0 20px rgba(22, 163, 74, 0.6); }
        }

        /* Ï†ÑÌà¨ ÏïÑÎ†àÎÇò */
        .battle-arena {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 10;
            padding: 20px;
        }

        .arena-ground {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100px;
            background: linear-gradient(180deg, 
                rgba(124, 45, 18, 0.3), 
                rgba(124, 45, 18, 0.8)
            );
            border-top: 2px solid var(--secondary);
        }

        /* Í≤ÄÏÇ¨Îì§ */
        .warriors-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            width: 100%;
            max-width: 800px;
            height: 400px;
            position: relative;
        }

        .warrior {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .warrior.player1 {
            transform: scaleX(-1); /* Ï¢åÏ∏° Í≤ÄÏÇ¨Îäî Îí§ÏßëÍ∏∞ */
        }

        .warrior-avatar {
            width: 120px;
            height: 200px;
            background: linear-gradient(180deg, 
                var(--text-secondary), 
                var(--surface)
            );
            border-radius: 60px 60px 20px 20px;
            position: relative;
            margin-bottom: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }

        /* Í≤ÄÏÇ¨ ÏñºÍµ¥ */
        .warrior-face {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            background: #fbbf24;
            border-radius: 50%;
            border: 2px solid var(--sword-gold);
        }

        /* Í≤Ä */
        .warrior-sword {
            position: absolute;
            top: 60px;
            right: -20px;
            width: 8px;
            height: 80px;
            background: linear-gradient(180deg, var(--sword-silver), #9ca3af);
            border-radius: 4px;
            transition: all 0.2s ease;
            transform-origin: bottom center;
            box-shadow: 0 0 10px rgba(229, 231, 235, 0.3);
        }

        .warrior-sword::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 8px;
            background: var(--sword-gold);
            border-radius: 4px;
        }

        /* Í≤ÄÏÇ¨ Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .warrior.attacking .warrior-avatar {
            animation: warrior-attack 0.5s ease-out;
        }

        .warrior.attacking .warrior-sword {
            animation: sword-slash 0.5s ease-out;
            box-shadow: 0 0 25px rgba(220, 38, 38, 0.8);
        }

        .warrior.defending .warrior-avatar {
            animation: warrior-defend 0.3s ease-out;
        }

        .warrior.defending .warrior-sword {
            transform: rotate(-45deg);
            box-shadow: 0 0 20px rgba(22, 163, 74, 0.8);
        }

        .warrior.hit .warrior-avatar {
            animation: warrior-hit 0.6s ease-out;
        }

        @keyframes warrior-attack {
            0% { transform: translateX(0); }
            50% { transform: translateX(20px) scale(1.05); }
            100% { transform: translateX(0); }
        }

        @keyframes sword-slash {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(45deg) scale(1.2); }
            100% { transform: rotate(0deg); }
        }

        @keyframes warrior-defend {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        @keyframes warrior-hit {
            0% { transform: translateX(0); filter: brightness(1); }
            25% { transform: translateX(-10px); filter: brightness(1.5) hue-rotate(0deg); }
            50% { transform: translateX(10px); filter: brightness(1.2) hue-rotate(15deg); }
            75% { transform: translateX(-5px); filter: brightness(1.3) hue-rotate(-15deg); }
            100% { transform: translateX(0); filter: brightness(1); }
        }

        /* Ï≤¥Î†• Î∞î */
        .health-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
        }

        .health-bar {
            background: rgba(26, 26, 26, 0.9);
            border: 2px solid rgba(220, 38, 38, 0.3);
            border-radius: 1rem;
            padding: 1rem;
            min-width: 200px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .health-bar h3 {
            color: var(--text-primary);
            margin-bottom: 0.8rem;
            text-align: center;
            font-size: 1.1rem;
        }

        .health-hearts {
            display: flex;
            justify-content: center;
            gap: 5px;
            font-size: 1.5rem;
        }

        .health-heart {
            transition: all 0.3s ease;
        }

        .health-heart.lost {
            opacity: 0.3;
            transform: scale(0.8);
            filter: grayscale(1);
        }

        /* Í≤åÏûÑ ÏÉÅÌÉú */
        .game-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
            padding: 1.5rem 2rem;
            border-radius: 1.5rem;
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(15px);
            border: 2px solid transparent;
            min-width: 350px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 200;
        }

        .state-waiting {
            color: var(--text-secondary);
            border-color: var(--text-secondary);
        }

        .state-ready {
            color: var(--accent);
            border-color: var(--accent);
            animation: ready-pulse 1.5s infinite;
            background: rgba(217, 119, 6, 0.1);
        }

        .state-countdown {
            color: var(--primary);
            border-color: var(--primary);
            background: rgba(220, 38, 38, 0.1);
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.5);
        }

        .state-fighting {
            color: var(--primary);
            border-color: var(--primary);
            background: rgba(220, 38, 38, 0.2);
            animation: fighting-pulse 1s ease-in-out infinite;
        }

        .state-finished {
            color: var(--sword-gold);
            border-color: var(--sword-gold);
            background: rgba(251, 191, 36, 0.2);
            box-shadow: 0 0 40px rgba(251, 191, 36, 0.6);
        }

        @keyframes ready-pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }

        @keyframes fighting-pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.02); opacity: 0.9; }
        }

        /* Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ */
        .countdown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            backdrop-filter: blur(5px);
        }

        .countdown-number {
            font-size: 12rem;
            font-weight: bold;
            color: var(--primary);
            text-shadow: 0 0 60px rgba(220, 38, 38, 0.9);
            animation: countdown-appear 1s ease-out;
        }

        @keyframes countdown-appear {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.3); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Ï†ÑÌà¨ Ìö®Í≥º */
        .battle-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 150;
        }

        .clash-effect {
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, 
                rgba(251, 191, 36, 0.9), 
                rgba(220, 38, 38, 0.6), 
                transparent
            );
            border-radius: 50%;
            animation: clash-explosion 0.8s ease-out forwards;
        }

        @keyframes clash-explosion {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(2); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(4); opacity: 0; }
        }

        .blood-effect {
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, 
                rgba(153, 27, 27, 0.9), 
                transparent
            );
            border-radius: 50%;
            animation: blood-splash 0.6s ease-out forwards;
        }

        @keyframes blood-splash {
            0% { transform: translate(-50%, -50%) scale(0) rotate(0deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(3) rotate(180deg); opacity: 0; }
        }

        /* ÏÉÅÌÉú Î©îÏãúÏßÄ */
        .battle-message {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-primary);
            background: rgba(26, 26, 26, 0.9);
            padding: 1rem 2rem;
            border-radius: 1rem;
            border: 1px solid rgba(220, 38, 38, 0.3);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 180;
        }

        .battle-message.show {
            opacity: 1;
            animation: message-slide 2s ease-out;
        }

        @keyframes message-slide {
            0% { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            20% { transform: translateX(-50%) translateY(0); opacity: 1; }
            80% { transform: translateX(-50%) translateY(0); opacity: 1; }
            100% { transform: translateX(-50%) translateY(-20px); opacity: 0; }
        }

        /* ÌÜµÍ≥Ñ Ìå®ÎÑê */
        .stats-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(26, 26, 26, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(220, 38, 38, 0.3);
            border-radius: 1rem;
            padding: 1rem;
            z-index: 50;
            min-width: 180px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .stats-panel h4 {
            color: var(--primary);
            margin-bottom: 0.8rem;
            text-align: center;
            font-size: 1rem;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.4rem;
            font-size: 0.9rem;
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Ïª®Ìä∏Î°§ Ìå®ÎÑê */
        .control-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
            z-index: 100;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 0.8rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
            position: relative;
            overflow: hidden;
        }

        .control-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .control-btn:hover::before {
            left: 100%;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .control-btn.start {
            background: linear-gradient(135deg, var(--success), #059669);
            box-shadow: 0 4px 16px rgba(22, 163, 74, 0.3);
        }

        .control-btn.restart {
            background: linear-gradient(135deg, var(--accent), #d97706);
            box-shadow: 0 4px 16px rgba(217, 119, 6, 0.3);
        }

        .control-btn.home {
            background: linear-gradient(135deg, var(--text-secondary), #64748b);
            box-shadow: 0 4px 16px rgba(100, 116, 139, 0.3);
        }

        /* Î°úÎî© */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 15, 15, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(220, 38, 38, 0.3);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ïà®ÍπÄ ÏÉÅÌÉú */
        .hidden {
            display: none !important;
        }

        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
        @media (max-width: 768px) {
            .session-title {
                font-size: 1.5rem;
            }
            
            .session-info {
                max-width: 250px;
                padding: 0.8rem;
            }
            
            .session-code {
                font-size: 1.8rem;
            }
            
            .qr-container canvas,
            .qr-container img {
                width: 110px !important;
                height: 110px !important;
            }
            
            .warriors-container {
                height: 300px;
            }
            
            .warrior-avatar {
                width: 100px;
                height: 160px;
            }
            
            .game-state {
                font-size: 1.5rem;
                min-width: 250px;
                padding: 1rem 1.5rem;
            }
            
            .countdown-number {
                font-size: 8rem;
            }
            
            .control-btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .warriors-container {
                height: 250px;
            }
            
            .warrior-avatar {
                width: 80px;
                height: 140px;
            }
            
            .health-bar {
                min-width: 150px;
                padding: 0.8rem;
            }
            
            .stats-panel {
                bottom: 70px;
                right: 10px;
                min-width: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Î∞∞Í≤Ω Ìö®Í≥º -->
        <div class="background-effects" id="backgroundEffects"></div>

        <!-- Î°úÎî© Ïò§Î≤ÑÎ†àÏù¥ -->
        <div class="loading-overlay hidden" id="loadingOverlay">
            <div class="loading-spinner"></div>
        </div>

        <!-- Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Ïò§Î≤ÑÎ†àÏù¥ -->
        <div class="countdown-overlay hidden" id="countdownOverlay">
            <div class="countdown-number" id="countdownNumber">3</div>
        </div>

        <!-- ÏÉÅÎã® ÏÑ∏ÏÖò Ï†ïÎ≥¥ -->
        <div class="game-header">
            <div class="session-title">‚öîÔ∏è Sword Fight</div>
            <div class="session-info hidden" id="sessionInfo">
                <div class="session-code" id="sessionCode">----</div>
                <div class="qr-container" id="qrContainer">
                    <div style="color: var(--text-secondary); font-size: 0.8rem;">QR ÏΩîÎìú ÏÉùÏÑ± Ï§ë...</div>
                </div>
                <div class="connection-status">
                    <div class="sensor-status sensor-disconnected" id="sensor1Status">
                        ‚öîÔ∏è Player 1: ÎåÄÍ∏∞Ï§ë
                    </div>
                    <div class="sensor-status sensor-disconnected" id="sensor2Status">
                        ‚öîÔ∏è Player 2: ÎåÄÍ∏∞Ï§ë
                    </div>
                </div>
            </div>
        </div>

        <!-- Ï†ÑÌà¨ ÏïÑÎ†àÎÇò -->
        <div class="battle-arena">
            <!-- Í≤åÏûÑ ÏÉÅÌÉú ÌëúÏãú -->
            <div class="game-state state-waiting" id="gameState">
                üéØ Îëê Î™ÖÏùò Í≤ÄÏÇ¨ Ïó∞Í≤∞ÏùÑ Í∏∞Îã§Î¶¨Îäî Ï§ë...
            </div>

            <!-- Ï≤¥Î†• Î∞î -->
            <div class="health-container hidden" id="healthContainer">
                <div class="health-bar">
                    <h3>Player 1</h3>
                    <div class="health-hearts" id="health1">
                        <span class="health-heart">‚ù§Ô∏è</span>
                        <span class="health-heart">‚ù§Ô∏è</span>
                        <span class="health-heart">‚ù§Ô∏è</span>
                        <span class="health-heart">‚ù§Ô∏è</span>
                        <span class="health-heart">‚ù§Ô∏è</span>
                    </div>
                </div>
                <div class="health-bar">
                    <h3>Player 2</h3>
                    <div class="health-hearts" id="health2">
                        <span class="health-heart">‚ù§Ô∏è</span>
                        <span class="health-heart">‚ù§Ô∏è</span>
                        <span class="health-heart">‚ù§Ô∏è</span>
                        <span class="health-heart">‚ù§Ô∏è</span>
                        <span class="health-heart">‚ù§Ô∏è</span>
                    </div>
                </div>
            </div>

            <!-- Í≤ÄÏÇ¨Îì§ -->
            <div class="warriors-container hidden" id="warriorsContainer">
                <div class="warrior player1" id="warrior1">
                    <div class="warrior-avatar">
                        <div class="warrior-face"></div>
                        <div class="warrior-sword"></div>
                    </div>
                </div>
                <div class="warrior player2" id="warrior2">
                    <div class="warrior-avatar">
                        <div class="warrior-face"></div>
                        <div class="warrior-sword"></div>
                    </div>
                </div>
            </div>

            <!-- ÏïÑÎ†àÎÇò Î∞îÎã• -->
            <div class="arena-ground"></div>

            <!-- Ï†ÑÌà¨ Î©îÏãúÏßÄ -->
            <div class="battle-message" id="battleMessage">Ï†ÑÌà¨ ÏãúÏûë!</div>
        </div>

        <!-- ÌÜµÍ≥Ñ Ìå®ÎÑê -->
        <div class="stats-panel hidden" id="statsPanel">
            <h4>‚öîÔ∏è Ï†ÑÌà¨ ÌÜµÍ≥Ñ</h4>
            <div class="stat-item">
                <span class="stat-label">ÎùºÏö¥Îìú:</span>
                <span class="stat-value" id="roundNumber">1</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Ï†ÑÌà¨ ÏãúÍ∞Ñ:</span>
                <span class="stat-value" id="battleTime">00:00</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Ï¥ù Í≥µÍ≤©:</span>
                <span class="stat-value" id="totalAttacks">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">ÏÑ±Í≥µÌïú Î∞©Ïñ¥:</span>
                <span class="stat-value" id="successfulBlocks">0</span>
            </div>
        </div>

        <!-- Ïª®Ìä∏Î°§ Ìå®ÎÑê -->
        <div class="control-panel">
            <button class="control-btn start" id="startBtn" onclick="startBattle()" disabled>
                ‚öîÔ∏è Ï†ÑÌà¨ ÏãúÏûë
            </button>
            <button class="control-btn restart" id="restartBtn" onclick="restartGame()">
                üîÑ Îã§Ïãú ÏãúÏûë
            </button>
            <a href="/" class="control-btn home">üè† ÌóàÎ∏åÎ°ú</a>
        </div>
    </div>

    <!-- Ïò§ÎîîÏò§ ÏöîÏÜåÎì§ -->
    <audio id="swordClashSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRvQCAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YdACAAC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4" type="audio/wav">
    </audio>

    <audio id="hitSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+T9u2kbDiyS3uS9biMGKo7A8tJ9KwYl" type="audio/wav">
    </audio>

    <audio id="blockSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRvgWAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YdQWAACb/7KDwQJvAI8Ig7l7fHE8hAGBAoYDfXl8fHuAE4J8gIGCfoIEhARCfYB8hn6BhHt7gImFfHmA" type="audio/wav">
    </audio>

    <!-- Socket.IO Î∞è SDK Î°úÎìú -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/SessionSDK.js"></script>
    
    <!-- QR ÏΩîÎìú ÎùºÏù¥Î∏åÎü¨Î¶¨ -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <script>
        class SwordFightGamePro {
            constructor() {
                // SDK Ï¥àÍ∏∞Ìôî
                this.sdk = new SessionSDK({
                    gameType: 'dual',
                    gameName: 'Sword Fight',
                    debug: false
                });

                // Í≤åÏûÑ ÏÉÅÌÉú
                this.gameState = 'waiting'; // waiting, ready, countdown, fighting, finished
                this.connectedSensors = new Map();
                this.session = null;
                this.battleStartTime = 0;

                // ÌîåÎ†àÏù¥Ïñ¥ Îç∞Ïù¥ÌÑ∞
                this.players = {
                    player1: { 
                        health: 5, 
                        isDefending: false, 
                        defenseType: null,
                        lastAttackTime: 0,
                        attackCount: 0,
                        blockCount: 0
                    },
                    player2: { 
                        health: 5, 
                        isDefending: false, 
                        defenseType: null,
                        lastAttackTime: 0,
                        attackCount: 0,
                        blockCount: 0
                    }
                };

                // Ï†ÑÌà¨ Î°úÏßÅ
                this.attackCooldown = 1000; // ms
                this.simultaneousAttackWindow = 200; // ms
                this.pendingAttacks = new Map();

                // ÌÜµÍ≥Ñ
                this.stats = {
                    roundNumber: 1,
                    totalAttacks: 0,
                    successfulBlocks: 0,
                    battleStartTime: 0
                };

                // ÌÉÄÏù¥Î®∏
                this.battleTimer = null;
                this.statsTimer = null;
                this.countdownTimer = null;

                // DOM ÏöîÏÜåÎì§
                this.elements = {
                    sessionInfo: document.getElementById('sessionInfo'),
                    sessionCode: document.getElementById('sessionCode'),
                    qrContainer: document.getElementById('qrContainer'),
                    sensor1Status: document.getElementById('sensor1Status'),
                    sensor2Status: document.getElementById('sensor2Status'),
                    gameState: document.getElementById('gameState'),
                    healthContainer: document.getElementById('healthContainer'),
                    health1: document.getElementById('health1'),
                    health2: document.getElementById('health2'),
                    warriorsContainer: document.getElementById('warriorsContainer'),
                    warrior1: document.getElementById('warrior1'),
                    warrior2: document.getElementById('warrior2'),
                    battleMessage: document.getElementById('battleMessage'),
                    statsPanel: document.getElementById('statsPanel'),
                    countdownOverlay: document.getElementById('countdownOverlay'),
                    countdownNumber: document.getElementById('countdownNumber'),
                    loadingOverlay: document.getElementById('loadingOverlay'),
                    backgroundEffects: document.getElementById('backgroundEffects'),
                    startBtn: document.getElementById('startBtn'),
                    restartBtn: document.getElementById('restartBtn'),
                    // ÌÜµÍ≥Ñ ÏöîÏÜåÎì§
                    roundNumber: document.getElementById('roundNumber'),
                    battleTime: document.getElementById('battleTime'),
                    totalAttacks: document.getElementById('totalAttacks'),
                    successfulBlocks: document.getElementById('successfulBlocks'),
                    // Ïò§ÎîîÏò§
                    swordClashSound: document.getElementById('swordClashSound'),
                    hitSound: document.getElementById('hitSound'),
                    blockSound: document.getElementById('blockSound')
                };

                this.initializeGame();
                this.setupEvents();
                this.createBackgroundEffects();
                this.startStatsUpdate();
                console.log('‚öîÔ∏è Sword Fight Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
            }

            initializeGame() {
                // Î°úÎî© ÌëúÏãú
                this.showLoading(true);
                
                setTimeout(() => {
                    this.showLoading(false);
                }, 1000);
            }

            createBackgroundEffects() {
                // Ïó†Î≤Ñ Ìö®Í≥º ÏÉùÏÑ±
                setInterval(() => {
                    this.createEmber();
                }, 3000);
            }

            createEmber() {
                const ember = document.createElement('div');
                ember.className = 'ember';
                
                const size = Math.random() * 4 + 2;
                ember.style.width = size + 'px';
                ember.style.height = size + 'px';
                ember.style.left = Math.random() * 100 + '%';
                ember.style.bottom = '0%';
                ember.style.animationDelay = Math.random() * 2 + 's';
                ember.style.animationDuration = (Math.random() * 4 + 4) + 's';
                
                this.elements.backgroundEffects.appendChild(ember);

                setTimeout(() => {
                    if (this.elements.backgroundEffects.contains(ember)) {
                        this.elements.backgroundEffects.removeChild(ember);
                    }
                }, 8000);
            }

            setupEvents() {
                // SDK Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
                this.sdk.on('connected', () => {
                    console.log('‚úÖ ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏôÑÎ£å');
                    this.createSession();
                });

                this.sdk.on('session-created', (event) => {
                    const session = event.detail || event;
                    console.log('üéØ ÏÑ∏ÏÖò ÏÉùÏÑ± ÏôÑÎ£å:', session);
                    this.session = session;
                    this.displaySessionInfo(session);
                });

                this.sdk.on('sensor-connected', (event) => {
                    const data = event.detail || event;
                    console.log('üì± ÏÑºÏÑú Ïó∞Í≤∞:', data);
                    this.handleSensorConnected(data);
                });

                this.sdk.on('sensor-disconnected', (event) => {
                    const data = event.detail || event;
                    console.log('üì± ÏÑºÏÑú Ïó∞Í≤∞ Ìï¥Ï†ú:', data);
                    this.handleSensorDisconnected(data);
                });

                this.sdk.on('game-ready', (event) => {
                    const data = event.detail || event;
                    console.log('üéÆ Í≤åÏûÑ Ï§ÄÎπÑ ÏôÑÎ£å:', data);
                    this.handleGameReady();
                });

                // Ïª§Ïä§ÌÖÄ ÏÜåÏºì Ïù¥Î≤§Ìä∏ (Sword Fight Ï†ÑÏö©)
                this.setupSwordFightEvents();

                // ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏ (Í∞úÎ∞ú/ÌÖåÏä§Ìä∏Ïö©)
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'r' || e.key === 'R') {
                        this.restartGame();
                    } else if (e.key === ' ') {
                        e.preventDefault();
                        if (this.gameState === 'ready') {
                            this.startBattle();
                        }
                    } else if (e.key === '1') {
                        this.simulateAttack('player1', 'vertical');
                    } else if (e.key === '2') {
                        this.simulateAttack('player2', 'horizontal');
                    }
                });

                // ÏúàÎèÑÏö∞ Ïù¥Î≤§Ìä∏
                window.addEventListener('beforeunload', () => {
                    this.cleanup();
                });
            }

            setupSwordFightEvents() {
                // ÏÜåÏºì Ïó∞Í≤∞ ÌôïÏù∏
                if (!this.sdk.socket) {
                    setTimeout(() => this.setupSwordFightEvents(), 100);
                    return;
                }

                // Sword Fight Ï†ÑÏö© Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
                this.sdk.socket.on('sword-attack', (data) => {
                    this.handlePlayerAttack(data);
                });

                this.sdk.socket.on('sword-defend-start', (data) => {
                    this.handleDefenseStart(data);
                });

                this.sdk.socket.on('sword-defend-stop', (data) => {
                    this.handleDefenseStop(data);
                });
            }

            async createSession() {
                try {
                    await this.sdk.createSession();
                } catch (error) {
                    console.error('‚ùå ÏÑ∏ÏÖò ÏÉùÏÑ± Ïã§Ìå®:', error);
                    this.elements.gameState.textContent = 'ÏÑ∏ÏÖò ÏÉùÏÑ± Ïã§Ìå®. ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.';
                }
            }

            displaySessionInfo(session) {
                this.elements.sessionCode.textContent = session.sessionCode;
                this.elements.sessionInfo.classList.remove('hidden');
                
                // Ï†ÑÏö© ÏÑºÏÑú ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ QR ÏΩîÎìú ÏÉùÏÑ±
                const qrUrl = `${window.location.origin}/games/sword-fight/sensor-client.html?session=${session.sessionCode}`;
                
                if (typeof QRCode !== 'undefined') {
                    QRCode.toCanvas(document.createElement('canvas'), qrUrl, (error, canvas) => {
                        if (!error) {
                            canvas.style.width = '130px';
                            canvas.style.height = '130px';
                            this.elements.qrContainer.innerHTML = '';
                            this.elements.qrContainer.appendChild(canvas);
                        } else {
                            this.showQRCodeFallback(qrUrl);
                        }
                    });
                } else {
                    this.showQRCodeFallback(qrUrl);
                }
            }

            showQRCodeFallback(qrUrl) {
                const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=130x130&data=${encodeURIComponent(qrUrl)}`;
                const img = document.createElement('img');
                img.src = qrApiUrl;
                img.style.width = '130px';
                img.style.height = '130px';
                this.elements.qrContainer.innerHTML = '';
                this.elements.qrContainer.appendChild(img);
            }

            handleSensorConnected(data) {
                const sensorId = data.sensorId;
                this.connectedSensors.set(sensorId, {
                    id: sensorId,
                    connected: true,
                    lastActivity: Date.now()
                });

                this.updateSensorStatus();
                this.playSwordClashSound();
                
                if (this.connectedSensors.size === 2) {
                    this.setGameState('ready');
                }
            }

            handleSensorDisconnected(data) {
                const sensorId = data.sensorId;
                this.connectedSensors.delete(sensorId);
                this.updateSensorStatus();
                
                if (this.connectedSensors.size < 2) {
                    this.setGameState('waiting');
                    this.elements.startBtn.disabled = true;
                }
            }

            updateSensorStatus() {
                const sensors = Array.from(this.connectedSensors.keys()).sort();
                
                // Player 1 ÏÉÅÌÉú
                const sensor1 = sensors[0];
                if (sensor1) {
                    this.elements.sensor1Status.textContent = '‚öîÔ∏è Player 1: Ïó∞Í≤∞Îê®';
                    this.elements.sensor1Status.className = 'sensor-status sensor-connected';
                } else {
                    this.elements.sensor1Status.textContent = '‚öîÔ∏è Player 1: ÎåÄÍ∏∞Ï§ë';
                    this.elements.sensor1Status.className = 'sensor-status sensor-disconnected';
                }

                // Player 2 ÏÉÅÌÉú
                const sensor2 = sensors[1];
                if (sensor2) {
                    this.elements.sensor2Status.textContent = '‚öîÔ∏è Player 2: Ïó∞Í≤∞Îê®';
                    this.elements.sensor2Status.className = 'sensor-status sensor-connected';
                } else {
                    this.elements.sensor2Status.textContent = '‚öîÔ∏è Player 2: ÎåÄÍ∏∞Ï§ë';
                    this.elements.sensor2Status.className = 'sensor-status sensor-disconnected';
                }
            }

            handleGameReady() {
                this.setGameState('ready');
                this.elements.startBtn.disabled = false;
            }

            setGameState(state) {
                this.gameState = state;
                
                const stateMessages = {
                    waiting: 'üéØ Îëê Î™ÖÏùò Í≤ÄÏÇ¨ Ïó∞Í≤∞ÏùÑ Í∏∞Îã§Î¶¨Îäî Ï§ë...',
                    ready: '‚öîÔ∏è Ï†ÑÌà¨ Ï§ÄÎπÑ ÏôÑÎ£å! ÏãúÏûë Î≤ÑÌäºÏùÑ ÎàÑÎ•¥ÏÑ∏Ïöî',
                    countdown: '‚öîÔ∏è Í≥ß Ï†ÑÌà¨Í∞Ä ÏãúÏûëÎê©ÎãàÎã§!',
                    fighting: '',
                    finished: ''
                };

                this.elements.gameState.textContent = stateMessages[state] || '';
                this.elements.gameState.className = `game-state state-${state}`;
                
                // UI ÌëúÏãú/Ïà®ÍπÄ Ï≤òÎ¶¨
                switch (state) {
                    case 'waiting':
                        this.elements.healthContainer.classList.add('hidden');
                        this.elements.warriorsContainer.classList.add('hidden');
                        this.elements.statsPanel.classList.add('hidden');
                        this.elements.gameState.classList.remove('hidden');
                        break;
                        
                    case 'ready':
                        this.elements.healthContainer.classList.remove('hidden');
                        this.elements.warriorsContainer.classList.remove('hidden');
                        this.elements.statsPanel.classList.remove('hidden');
                        this.elements.gameState.classList.remove('hidden');
                        break;
                        
                    case 'countdown':
                        this.elements.gameState.classList.remove('hidden');
                        break;
                        
                    case 'fighting':
                        this.elements.gameState.classList.add('hidden');
                        this.elements.startBtn.disabled = true;
                        break;
                        
                    case 'finished':
                        this.elements.gameState.classList.remove('hidden');
                        this.elements.startBtn.disabled = true;
                        break;
                }
            }

            startBattle() {
                if (this.gameState !== 'ready') return;
                if (this.connectedSensors.size < 2) {
                    alert('Îëê Î™ÖÏùò Í≤ÄÏÇ¨Í∞Ä Î™®Îëê Ïó∞Í≤∞ÎêòÏñ¥Ïïº Ìï©ÎãàÎã§!');
                    return;
                }

                this.setGameState('countdown');
                this.showCountdown();
            }

            showCountdown() {
                let count = 3;
                this.elements.countdownOverlay.classList.remove('hidden');
                
                const countdownInterval = setInterval(() => {
                    if (count > 0) {
                        this.elements.countdownNumber.textContent = count;
                        this.playSwordClashSound();
                        count--;
                    } else {
                        this.elements.countdownNumber.textContent = 'FIGHT!';
                        this.playSwordClashSound();
                        
                        // ÏÑºÏÑú ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Ïóê Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÏïåÎ¶º
                        if (this.sdk.socket) {
                            this.sdk.socket.emit('sword-fight-countdown', {
                                sessionCode: this.session.sessionCode,
                                count: 0
                            });
                        }
                        
                        setTimeout(() => {
                            this.elements.countdownOverlay.classList.add('hidden');
                            this.startFighting();
                        }, 1000);
                        
                        clearInterval(countdownInterval);
                    }
                    
                    // ÏÑºÏÑú ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Ïóê Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÏïåÎ¶º
                    if (this.sdk.socket && count >= 0) {
                        this.sdk.socket.emit('sword-fight-countdown', {
                            sessionCode: this.session.sessionCode,
                            count: count + 1
                        });
                    }
                }, 1000);
            }

            startFighting() {
                this.setGameState('fighting');
                this.battleStartTime = Date.now();
                this.stats.battleStartTime = this.battleStartTime;
                
                // ÏÑºÏÑú ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Ïóê Ï†ÑÌà¨ ÏãúÏûë ÏïåÎ¶º
                if (this.sdk.socket) {
                    this.sdk.socket.emit('sword-fight-state-change', {
                        sessionCode: this.session.sessionCode,
                        state: 'fighting'
                    });
                }
                
                this.showBattleMessage('‚öîÔ∏è Ï†ÑÌà¨ ÏãúÏûë!');
                console.log('‚öîÔ∏è Ï†ÑÌà¨ ÏãúÏûë!');
            }

            handlePlayerAttack(data) {
                if (this.gameState !== 'fighting') return;

                const playerId = `player${data.playerId}`;
                const player = this.players[playerId];
                const now = Date.now();

                // Í≥µÍ≤© Ïø®Îã§Ïö¥ Ï≤¥ÌÅ¨
                if (now - player.lastAttackTime < this.attackCooldown) {
                    console.log(`‚öîÔ∏è ${playerId} Í≥µÍ≤© Ïø®Îã§Ïö¥ Ï§ë`);
                    return;
                }

                player.lastAttackTime = now;
                player.attackCount++;
                this.stats.totalAttacks++;

                // Í≥µÍ≤© Ïï†ÎãàÎ©îÏù¥ÏÖò
                this.playWarriorAnimation(playerId, 'attacking');
                
                // ÎèôÏãú Í≥µÍ≤© Ï≤¥ÌÅ¨Î•º ÏúÑÌï¥ Ïû†Ïãú ÎåÄÍ∏∞
                this.pendingAttacks.set(playerId, {
                    attackType: data.attackType,
                    timestamp: now
                });

                setTimeout(() => {
                    this.processPendingAttacks();
                }, this.simultaneousAttackWindow);

                console.log(`‚öîÔ∏è ${playerId} ${data.attackType} Í≥µÍ≤©!`);
            }

            processPendingAttacks() {
                if (this.pendingAttacks.size === 0) return;

                const attacks = Array.from(this.pendingAttacks.entries());
                this.pendingAttacks.clear();

                if (attacks.length === 2) {
                    // ÎèôÏãú Í≥µÍ≤©
                    this.handleSimultaneousAttack(attacks);
                } else if (attacks.length === 1) {
                    // Îã®Ïùº Í≥µÍ≤©
                    const [attackerId, attackData] = attacks[0];
                    this.handleSingleAttack(attackerId, attackData);
                }
            }

            handleSimultaneousAttack(attacks) {
                this.showBattleMessage('üí• ÎèôÏãú Í≥µÍ≤©! Îëò Îã§ Îç∞ÎØ∏ÏßÄ!');
                this.createBattleEffect('clash');
                
                // Îëò Îã§ Îç∞ÎØ∏ÏßÄ
                attacks.forEach(([playerId, attackData]) => {
                    this.dealDamage(playerId);
                    this.playWarriorAnimation(playerId, 'hit');
                });

                this.playSwordClashSound();
                this.updateHealthDisplay();
                this.checkGameEnd();

                // ÏÑºÏÑú ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Ïóê Í≤∞Í≥º ÏïåÎ¶º
                if (this.sdk.socket) {
                    this.sdk.socket.emit('sword-fight-result', {
                        sessionCode: this.session.sessionCode,
                        result: 'simultaneous'
                    });
                }

                console.log('üí• ÎèôÏãú Í≥µÍ≤© Î∞úÏÉù!');
            }

            handleSingleAttack(attackerId, attackData) {
                const defenderId = attackerId === 'player1' ? 'player2' : 'player1';
                const defender = this.players[defenderId];

                // Î∞©Ïñ¥ Ï≤¥ÌÅ¨
                if (defender.isDefending && this.isValidDefense(attackData.attackType, defender.defenseType)) {
                    // Î∞©Ïñ¥ ÏÑ±Í≥µ
                    this.handleSuccessfulDefense(attackerId, defenderId, attackData);
                } else if (defender.isDefending) {
                    // ÏûòÎ™ªÎêú Î∞©Ïñ¥
                    this.handleFailedDefense(attackerId, defenderId, attackData);
                } else {
                    // Î∞©Ïñ¥ ÏóÜÏùå
                    this.handleUndefendedAttack(attackerId, defenderId, attackData);
                }
            }

            isValidDefense(attackType, defenseType) {
                // Í≥µÍ≤©Í≥º ÏàòÏßÅ Î∞©Ìñ•ÏúºÎ°ú Î∞©Ïñ¥Ìï¥Ïïº ÏÑ±Í≥µ
                return (attackType === 'vertical' && defenseType === 'horizontal') ||
                       (attackType === 'horizontal' && defenseType === 'vertical');
            }

            handleSuccessfulDefense(attackerId, defenderId, attackData) {
                this.showBattleMessage('üõ°Ô∏è Î∞©Ïñ¥ ÏÑ±Í≥µ!');
                this.createBattleEffect('clash');
                
                this.playWarriorAnimation(defenderId, 'defending');
                this.players[defenderId].blockCount++;
                this.stats.successfulBlocks++;
                
                this.playBlockSound();

                // ÏÑºÏÑú ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Ïóê Í≤∞Í≥º ÏïåÎ¶º
                if (this.sdk.socket) {
                    this.sdk.socket.emit('sword-fight-result', {
                        sessionCode: this.session.sessionCode,
                        result: 'blocked',
                        attackerPlayerId: attackerId.slice(-1),
                        defenderPlayerId: defenderId.slice(-1)
                    });
                }

                console.log(`üõ°Ô∏è ${defenderId} Î∞©Ïñ¥ ÏÑ±Í≥µ!`);
            }

            handleFailedDefense(attackerId, defenderId, attackData) {
                this.showBattleMessage('üíî ÏûòÎ™ªÎêú Î∞©Ïñ¥! Í≥µÍ≤© ÏÑ±Í≥µ!');
                this.createBattleEffect('blood');
                
                this.dealDamage(defenderId);
                this.playWarriorAnimation(defenderId, 'hit');
                
                this.playHitSound();
                this.updateHealthDisplay();
                this.checkGameEnd();

                // ÏÑºÏÑú ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Ïóê Í≤∞Í≥º ÏïåÎ¶º
                if (this.sdk.socket) {
                    this.sdk.socket.emit('sword-fight-result', {
                        sessionCode: this.session.sessionCode,
                        result: 'hit',
                        attackerPlayerId: attackerId.slice(-1),
                        victimPlayerId: defenderId.slice(-1)
                    });
                }

                console.log(`üíî ${defenderId} ÏûòÎ™ªÎêú Î∞©Ïñ¥Î°ú ÌîºÌï¥!`);
            }

            handleUndefendedAttack(attackerId, defenderId, attackData) {
                // 50% ÌôïÎ•†Î°ú Ï†ÅÏ§ë/ÎπóÎÇòÍ∞ê
                if (Math.random() < 0.5) {
                    // Ï†ÅÏ§ë
                    this.showBattleMessage('üí• Í≥µÍ≤© Ï†ÅÏ§ë!');
                    this.createBattleEffect('blood');
                    
                    this.dealDamage(defenderId);
                    this.playWarriorAnimation(defenderId, 'hit');
                    
                    this.playHitSound();
                    this.updateHealthDisplay();
                    this.checkGameEnd();

                    // ÏÑºÏÑú ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Ïóê Í≤∞Í≥º ÏïåÎ¶º
                    if (this.sdk.socket) {
                        this.sdk.socket.emit('sword-fight-result', {
                            sessionCode: this.session.sessionCode,
                            result: 'hit',
                            attackerPlayerId: attackerId.slice(-1),
                            victimPlayerId: defenderId.slice(-1)
                        });
                    }
                } else {
                    // ÎπóÎÇòÍ∞ê
                    this.showBattleMessage('üí® Í≥µÍ≤©Ïù¥ ÎπóÎÇòÍ∞îÏäµÎãàÎã§!');
                    this.playSwordClashSound();

                    // ÏÑºÏÑú ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Ïóê Í≤∞Í≥º ÏïåÎ¶º
                    if (this.sdk.socket) {
                        this.sdk.socket.emit('sword-fight-result', {
                            sessionCode: this.session.sessionCode,
                            result: 'miss',
                            attackerPlayerId: attackerId.slice(-1)
                        });
                    }
                }

                console.log(`üí• ${attackerId} Î¨¥Î∞©Ïñ¥ Í≥µÍ≤© ${Math.random() < 0.5 ? 'Ï†ÅÏ§ë' : 'ÎπóÎÇòÍ∞ê'}!`);
            }

            handleDefenseStart(data) {
                const playerId = `player${data.playerId}`;
                const player = this.players[playerId];
                
                player.isDefending = true;
                // Î∞©Ïñ¥ Î∞©Ìñ•ÏùÄ ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Í≤∞Ï†ï (Ï∂îÌõÑ Íµ¨ÌòÑ Í∞ÄÎä•)
                player.defenseType = 'horizontal'; // Í∏∞Î≥∏Í∞í
                
                this.playWarriorAnimation(playerId, 'defending');
                console.log(`üõ°Ô∏è ${playerId} Î∞©Ïñ¥ ÏãúÏûë`);
            }

            handleDefenseStop(data) {
                const playerId = `player${data.playerId}`;
                const player = this.players[playerId];
                
                player.isDefending = false;
                player.defenseType = null;
                
                this.stopWarriorAnimation(playerId, 'defending');
                console.log(`üõ°Ô∏è ${playerId} Î∞©Ïñ¥ Ï¢ÖÎ£å`);
            }

            dealDamage(playerId) {
                this.players[playerId].health--;
                
                // ÏÑºÏÑú ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Ïóê Ï≤¥Î†• ÏóÖÎç∞Ïù¥Ìä∏ ÏïåÎ¶º
                if (this.sdk.socket) {
                    const playerNumber = playerId.slice(-1);
                    this.sdk.socket.emit('sword-fight-health-update', {
                        sessionCode: this.session.sessionCode,
                        myHealth: playerNumber === '1' ? this.players.player1.health : this.players.player2.health,
                        enemyHealth: playerNumber === '1' ? this.players.player2.health : this.players.player1.health,
                        targetPlayerId: playerNumber
                    });
                }
            }

            updateHealthDisplay() {
                // Player 1 Ï≤¥Î†• ÏóÖÎç∞Ïù¥Ìä∏
                const hearts1 = this.elements.health1.querySelectorAll('.health-heart');
                hearts1.forEach((heart, index) => {
                    if (index < this.players.player1.health) {
                        heart.classList.remove('lost');
                        heart.textContent = '‚ù§Ô∏è';
                    } else {
                        heart.classList.add('lost');
                        heart.textContent = 'üíî';
                    }
                });

                // Player 2 Ï≤¥Î†• ÏóÖÎç∞Ïù¥Ìä∏
                const hearts2 = this.elements.health2.querySelectorAll('.health-heart');
                hearts2.forEach((heart, index) => {
                    if (index < this.players.player2.health) {
                        heart.classList.remove('lost');
                        heart.textContent = '‚ù§Ô∏è';
                    } else {
                        heart.classList.add('lost');
                        heart.textContent = 'üíî';
                    }
                });
            }

            checkGameEnd() {
                if (this.players.player1.health <= 0) {
                    this.endGame('player2');
                } else if (this.players.player2.health <= 0) {
                    this.endGame('player1');
                }
            }

            endGame(winner) {
                this.setGameState('finished');
                
                const winnerName = winner === 'player1' ? 'Player 1' : 'Player 2';
                this.elements.gameState.textContent = `üèÜ ${winnerName} ÏäπÎ¶¨!`;
                
                this.showBattleMessage(`üèÜ ${winnerName} ÏäπÎ¶¨!`);
                this.createVictoryEffect();
                
                // ÏÑºÏÑú ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Ïóê Í≤åÏûÑ Ï¢ÖÎ£å ÏïåÎ¶º
                if (this.sdk.socket) {
                    this.sdk.socket.emit('sword-fight-state-change', {
                        sessionCode: this.session.sessionCode,
                        state: 'finished',
                        winner: winner
                    });
                }
                
                console.log(`üèÜ Í≤åÏûÑ Ï¢ÖÎ£å! ${winner} ÏäπÎ¶¨`);
            }

            playWarriorAnimation(playerId, animationType) {
                const warrior = this.elements[`warrior${playerId.slice(-1)}`];
                warrior.classList.add(animationType);
                
                setTimeout(() => {
                    warrior.classList.remove(animationType);
                }, animationType === 'hit' ? 600 : 500);
            }

            stopWarriorAnimation(playerId, animationType) {
                const warrior = this.elements[`warrior${playerId.slice(-1)}`];
                warrior.classList.remove(animationType);
            }

            createBattleEffect(type) {
                const effect = document.createElement('div');
                effect.className = `battle-effect ${type}-effect`;
                
                this.elements.battleArena.appendChild(effect);
                
                setTimeout(() => {
                    if (this.elements.battleArena.contains(effect)) {
                        this.elements.battleArena.removeChild(effect);
                    }
                }, type === 'clash' ? 800 : 600);
            }

            createVictoryEffect() {
                // Îã§Ï§ë ÌååÌã∞ÌÅ¥ Ìö®Í≥º
                for (let i = 0; i < 10; i++) {
                    setTimeout(() => {
                        this.createBattleEffect('clash');
                    }, i * 200);
                }
            }

            showBattleMessage(message) {
                this.elements.battleMessage.textContent = message;
                this.elements.battleMessage.classList.add('show');
                
                setTimeout(() => {
                    this.elements.battleMessage.classList.remove('show');
                }, 2000);
            }

            restartGame() {
                // Í≤åÏûÑ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                this.gameState = 'waiting';
                this.players.player1 = { health: 5, isDefending: false, defenseType: null, lastAttackTime: 0, attackCount: 0, blockCount: 0 };
                this.players.player2 = { health: 5, isDefending: false, defenseType: null, lastAttackTime: 0, attackCount: 0, blockCount: 0 };
                this.stats = { roundNumber: 1, totalAttacks: 0, successfulBlocks: 0, battleStartTime: 0 };
                this.pendingAttacks.clear();
                
                // UI Ï¥àÍ∏∞Ìôî
                this.updateHealthDisplay();
                this.updateStatsDisplay();
                
                // Ïó∞Í≤∞Îêú ÏÑºÏÑúÍ∞Ä ÏûàÏúºÎ©¥ ready ÏÉÅÌÉúÎ°ú
                if (this.connectedSensors.size === 2) {
                    this.setGameState('ready');
                    this.elements.startBtn.disabled = false;
                } else {
                    this.setGameState('waiting');
                    this.elements.startBtn.disabled = true;
                }
                
                console.log('üîÑ Í≤åÏûÑ Ïû¨ÏãúÏûë');
            }

            // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            startStatsUpdate() {
                this.statsTimer = setInterval(() => {
                    this.updateStatsDisplay();
                }, 1000);
            }

            updateStatsDisplay() {
                this.elements.roundNumber.textContent = this.stats.roundNumber;
                this.elements.totalAttacks.textContent = this.stats.totalAttacks;
                this.elements.successfulBlocks.textContent = this.stats.successfulBlocks;
                
                if (this.stats.battleStartTime > 0) {
                    const elapsed = Math.floor((Date.now() - this.stats.battleStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    this.elements.battleTime.textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }

            // ÏãúÎÆ¨Î†àÏù¥ÏÖò (Í∞úÎ∞ú/ÌÖåÏä§Ìä∏Ïö©)
            simulateAttack(playerId, attackType) {
                if (this.gameState === 'fighting') {
                    this.handlePlayerAttack({
                        playerId: playerId.slice(-1),
                        attackType: attackType,
                        timestamp: Date.now()
                    });
                }
            }

            // Ïò§ÎîîÏò§
            playSwordClashSound() {
                if (this.elements.swordClashSound) {
                    this.elements.swordClashSound.currentTime = 0;
                    this.elements.swordClashSound.play().catch(() => {});
                }
            }

            playHitSound() {
                if (this.elements.hitSound) {
                    this.elements.hitSound.currentTime = 0;
                    this.elements.hitSound.play().catch(() => {});
                }
            }

            playBlockSound() {
                if (this.elements.blockSound) {
                    this.elements.blockSound.currentTime = 0;
                    this.elements.blockSound.play().catch(() => {});
                }
            }

            // Ïú†Ìã∏Î¶¨Ìã∞
            showLoading(show) {
                this.elements.loadingOverlay.classList.toggle('hidden', !show);
            }

            cleanup() {
                if (this.statsTimer) clearInterval(this.statsTimer);
                if (this.countdownTimer) clearInterval(this.countdownTimer);
                
                console.log('üßπ Sword Fight Ï†ïÎ¶¨ ÏôÑÎ£å');
            }
        }

        // Ï†ÑÏó≠ Ìï®ÏàòÎì§
        function startBattle() {
            if (window.swordFightGame) {
                window.swordFightGame.startBattle();
            }
        }

        function restartGame() {
            if (window.swordFightGame) {
                window.swordFightGame.restartGame();
            }
        }

        // Í≤åÏûÑ Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
        window.addEventListener('load', () => {
            window.swordFightGame = new SwordFightGamePro();
        });

        // Ï†ïÎ¶¨
        window.addEventListener('beforeunload', () => {
            if (window.swordFightGame) {
                window.swordFightGame.cleanup();
            }
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öîÔ∏è Sword Fight - ÏÑºÏÑú ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏</title>
    <style>
        :root {
            --primary: #dc2626;
            --secondary: #7c2d12;
            --success: #16a34a;
            --warning: #d97706;
            --error: #ef4444;
            --background: #0f0f0f;
            --surface: #1a1a1a;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --accent: #f59e0b;
            --sword-silver: #e5e7eb;
            --sword-gold: #fbbf24;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--background), var(--surface));
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
            user-select: none;
            position: relative;
        }

        /* Î∞∞Í≤Ω Ìö®Í≥º */
        .background-effects {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .spark {
            position: absolute;
            width: 3px;
            height: 3px;
            background: var(--sword-gold);
            border-radius: 50%;
            animation: spark-fly 3s ease-out infinite;
        }

        @keyframes spark-fly {
            0% { 
                opacity: 1; 
                transform: scale(1) rotate(0deg); 
            }
            100% { 
                opacity: 0; 
                transform: scale(0) rotate(360deg) translateY(-100px); 
            }
        }

        /* Ïª®ÌÖåÏù¥ÎÑà */
        .sensor-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 10;
        }

        /* ÏÉÅÎã® ÏÉÅÌÉú Ï†ïÎ≥¥ */
        .status-header {
            text-align: center;
            margin-bottom: 30px;
            z-index: 100;
        }

        .game-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(220, 38, 38, 0.5);
        }

        .connection-status {
            background: rgba(26, 26, 26, 0.9);
            backdrop-filter: blur(12px);
            border: 2px solid rgba(220, 38, 38, 0.3);
            border-radius: 1rem;
            padding: 1rem;
            margin: 0 auto;
            max-width: 300px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .status-label {
            color: var(--text-secondary);
        }

        .status-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .status-connected {
            color: var(--success);
        }

        .status-disconnected {
            color: var(--error);
        }

        /* Í≤Ä ÏãúÍ∞ÅÌôî */
        .sword-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            margin: 20px 0;
        }

        .sword-container {
            position: relative;
            width: 200px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sword {
            width: 20px;
            height: 200px;
            background: linear-gradient(180deg, var(--sword-silver), #9ca3af);
            border-radius: 10px 10px 5px 5px;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 
                0 0 20px rgba(229, 231, 235, 0.5),
                inset -2px 0 10px rgba(0, 0, 0, 0.3);
        }

        .sword::before {
            content: '';
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 30px;
            background: linear-gradient(45deg, var(--sword-gold), #f59e0b);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
        }

        .sword.attacking {
            animation: sword-glow 0.5s ease-out;
            box-shadow: 
                0 0 40px rgba(220, 38, 38, 0.8),
                inset -2px 0 10px rgba(0, 0, 0, 0.3);
        }

        .sword.defending {
            animation: sword-defend 0.3s ease-out;
            box-shadow: 
                0 0 30px rgba(22, 163, 74, 0.8),
                inset -2px 0 10px rgba(0, 0, 0, 0.3);
        }

        @keyframes sword-glow {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        @keyframes sword-defend {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Î∞©Ìñ• ÌëúÏãú */
        .attack-direction {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.2rem;
            color: var(--primary);
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .attack-direction.show {
            opacity: 1;
            animation: direction-pulse 1s ease-out;
        }

        @keyframes direction-pulse {
            0% { transform: translateX(-50%) scale(0.8); }
            50% { transform: translateX(-50%) scale(1.2); }
            100% { transform: translateX(-50%) scale(1); }
        }

        .defense-direction {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1rem;
            color: var(--success);
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .defense-direction.show {
            opacity: 1;
        }

        /* Î∞©Ïñ¥ Î≤ÑÌäº */
        .defense-controls {
            margin-bottom: 30px;
        }

        .defense-button {
            width: 200px;
            height: 80px;
            background: linear-gradient(135deg, var(--success), #059669);
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 auto;
            display: block;
            box-shadow: 0 8px 25px rgba(22, 163, 74, 0.4);
            position: relative;
            overflow: hidden;
        }

        .defense-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .defense-button:hover::before {
            left: 100%;
        }

        .defense-button:active,
        .defense-button.defending {
            transform: scale(0.95);
            background: linear-gradient(135deg, #15803d, #047857);
            box-shadow: 
                0 4px 15px rgba(22, 163, 74, 0.6),
                0 0 30px rgba(22, 163, 74, 0.8);
        }

        .defense-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ÏÉÅÌÉú Î©îÏãúÏßÄ */
        .status-message {
            text-align: center;
            margin-bottom: 20px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message-text {
            font-size: 1.1rem;
            font-weight: 600;
            padding: 1rem 2rem;
            border-radius: 1rem;
            background: rgba(26, 26, 26, 0.8);
            border: 1px solid rgba(220, 38, 38, 0.3);
            transition: all 0.3s ease;
        }

        .message-waiting {
            color: var(--text-secondary);
            border-color: rgba(156, 163, 175, 0.3);
        }

        .message-ready {
            color: var(--accent);
            border-color: rgba(217, 119, 6, 0.5);
            background: rgba(217, 119, 6, 0.1);
        }

        .message-fighting {
            color: var(--primary);
            border-color: rgba(220, 38, 38, 0.5);
            background: rgba(220, 38, 38, 0.1);
            animation: message-pulse 2s ease-in-out infinite;
        }

        @keyframes message-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Ï≤¥Î†• ÌëúÏãú */
        .health-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(26, 26, 26, 0.9);
            border: 2px solid rgba(220, 38, 38, 0.3);
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .health-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .health-hearts {
            margin-left: 0.5rem;
            color: var(--primary);
        }

        /* ÏßÑÎèô Î∞è Ìö®Í≥º */
        .impact-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(220, 38, 38, 0.8), transparent);
            border-radius: 50%;
            animation: impact-blast 0.6s ease-out forwards;
            pointer-events: none;
            z-index: 200;
        }

        @keyframes impact-blast {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(4); opacity: 0; }
        }

        /* Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .countdown-number {
            font-size: 8rem;
            font-weight: bold;
            color: var(--primary);
            text-shadow: 0 0 50px rgba(220, 38, 38, 0.8);
            animation: countdown-pulse 1s ease-in-out;
        }

        @keyframes countdown-pulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
        @media (max-width: 480px) {
            .sensor-container {
                padding: 15px;
            }

            .game-title {
                font-size: 2rem;
            }

            .sword-container {
                width: 150px;
                height: 250px;
            }

            .sword {
                width: 15px;
                height: 150px;
            }

            .defense-button {
                width: 180px;
                height: 70px;
                font-size: 1.3rem;
            }

            .health-display {
                top: 10px;
                right: 10px;
                padding: 0.8rem;
            }
        }

        /* Ïà®ÍπÄ ÏÉÅÌÉú */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="background-effects" id="backgroundEffects"></div>

    <div class="sensor-container">
        <!-- ÏÉÅÎã® ÏÉÅÌÉú Ï†ïÎ≥¥ -->
        <div class="status-header">
            <div class="game-title">‚öîÔ∏è Sword Fight</div>
            <div class="connection-status">
                <div class="status-item">
                    <span class="status-label">ÏÑ∏ÏÖò:</span>
                    <span class="status-value" id="sessionCode">Ïó∞Í≤∞ Ï§ë...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ÏÉÅÌÉú:</span>
                    <span class="status-value status-disconnected" id="connectionStatus">Ïó∞Í≤∞ ÎåÄÍ∏∞</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ÌîåÎ†àÏù¥Ïñ¥:</span>
                    <span class="status-value" id="playerNumber">-</span>
                </div>
            </div>
        </div>

        <!-- Ï≤¥Î†• ÌëúÏãú -->
        <div class="health-display">
            <div class="health-item">
                <span>ÎÇ¥ Ï≤¥Î†•:</span>
                <span class="health-hearts" id="myHealth">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
            </div>
            <div class="health-item">
                <span>ÏÉÅÎåÄ Ï≤¥Î†•:</span>
                <span class="health-hearts" id="enemyHealth">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
            </div>
        </div>

        <!-- ÏÉÅÌÉú Î©îÏãúÏßÄ -->
        <div class="status-message">
            <div class="message-text message-waiting" id="statusMessage">
                Í≤åÏûÑ Ïó∞Í≤∞ÏùÑ Í∏∞Îã§Î¶¨Îäî Ï§ë...
            </div>
        </div>

        <!-- Í≤Ä ÏãúÍ∞ÅÌôî -->
        <div class="sword-display">
            <div class="attack-direction" id="attackDirection">‚¨áÔ∏è ÏàòÏßÅ Í≥µÍ≤©</div>
            <div class="sword-container">
                <div class="sword" id="sword"></div>
            </div>
            <div class="defense-direction" id="defenseDirection">‚¨ÖÔ∏è‚û°Ô∏è ÏàòÌèâ Î∞©Ïñ¥</div>
        </div>

        <!-- Î∞©Ïñ¥ Ïª®Ìä∏Î°§ -->
        <div class="defense-controls">
            <button class="defense-button" id="defenseButton" disabled>
                üõ°Ô∏è Î∞©Ïñ¥
            </button>
        </div>
    </div>

    <!-- Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Ïò§Î≤ÑÎ†àÏù¥ -->
    <div class="countdown-overlay hidden" id="countdownOverlay">
        <div class="countdown-number" id="countdownNumber">3</div>
    </div>

    <!-- Socket.IO Î°úÎìú -->
    <script src="/socket.io/socket.io.js"></script>
    
    <script>
        class SwordFightSensorClient {
            constructor() {
                // Ï¥àÍ∏∞ ÏÉÅÌÉú
                this.sessionCode = new URLSearchParams(window.location.search).get('session');
                this.socket = null;
                this.deviceOrientationPermission = false;
                this.isConnected = false;
                this.isDefending = false;
                this.gameState = 'waiting'; // waiting, ready, countdown, fighting, finished
                this.playerNumber = null;
                this.myHealth = 5;
                this.enemyHealth = 5;
                
                // ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞
                this.lastSensorData = null;
                this.swingThreshold = 20;
                this.swingCooldown = 500; // ms
                this.lastSwingTime = 0;
                
                // DOM ÏöîÏÜåÎì§
                this.elements = {
                    sessionCode: document.getElementById('sessionCode'),
                    connectionStatus: document.getElementById('connectionStatus'),
                    playerNumber: document.getElementById('playerNumber'),
                    statusMessage: document.getElementById('statusMessage'),
                    sword: document.getElementById('sword'),
                    attackDirection: document.getElementById('attackDirection'),
                    defenseDirection: document.getElementById('defenseDirection'),
                    defenseButton: document.getElementById('defenseButton'),
                    myHealth: document.getElementById('myHealth'),
                    enemyHealth: document.getElementById('enemyHealth'),
                    countdownOverlay: document.getElementById('countdownOverlay'),
                    countdownNumber: document.getElementById('countdownNumber'),
                    backgroundEffects: document.getElementById('backgroundEffects')
                };

                this.initializeClient();
                this.setupEvents();
                this.createBackgroundEffects();
                console.log('‚öîÔ∏è Sword Fight ÏÑºÏÑú ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
            }

            initializeClient() {
                if (!this.sessionCode) {
                    this.showMessage('ÏÑ∏ÏÖò ÏΩîÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§.', 'error');
                    return;
                }

                this.elements.sessionCode.textContent = this.sessionCode;
                this.connectToGame();
            }

            setupEvents() {
                // Î∞©Ïñ¥ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
                this.elements.defenseButton.addEventListener('mousedown', () => this.startDefense());
                this.elements.defenseButton.addEventListener('mouseup', () => this.stopDefense());
                this.elements.defenseButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startDefense();
                });
                this.elements.defenseButton.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.stopDefense();
                });

                // ÏÑºÏÑú Í∂åÌïú ÏöîÏ≤≠
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    // iOS 13+ Í∂åÌïú ÏöîÏ≤≠
                    document.addEventListener('click', () => {
                        if (!this.deviceOrientationPermission) {
                            this.requestSensorPermission();
                        }
                    }, { once: true });
                } else {
                    // Android ÎòêÎäî Íµ¨Ìòï iOS
                    this.deviceOrientationPermission = true;
                    this.startSensorListening();
                }

                // ÏúàÎèÑÏö∞ Ïù¥Î≤§Ìä∏
                window.addEventListener('beforeunload', () => {
                    this.disconnect();
                });
            }

            async requestSensorPermission() {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') {
                        this.deviceOrientationPermission = true;
                        this.startSensorListening();
                        this.showMessage('ÏÑºÏÑú Í∂åÌïúÏù¥ ÏäπÏù∏ÎêòÏóàÏäµÎãàÎã§.', 'success');
                    } else {
                        this.showMessage('ÏÑºÏÑú Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.', 'error');
                    }
                } catch (error) {
                    console.error('ÏÑºÏÑú Í∂åÌïú ÏöîÏ≤≠ Ïã§Ìå®:', error);
                    this.showMessage('ÏÑºÏÑú Í∂åÌïú ÏöîÏ≤≠Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                }
            }

            startSensorListening() {
                if (!this.deviceOrientationPermission) return;

                // Í∞ÄÏÜçÎèÑÍ≥Ñ Ïù¥Î≤§Ìä∏
                window.addEventListener('devicemotion', (event) => {
                    this.processSensorData(event);
                });

                // ÏûêÏù¥Î°úÏä§ÏΩîÌîÑ Ïù¥Î≤§Ìä∏
                window.addEventListener('deviceorientation', (event) => {
                    this.processOrientationData(event);
                });

                console.log('üì± ÏÑºÏÑú Î¶¨Ïä§Îãù ÏãúÏûë');
            }

            processSensorData(event) {
                if (!this.isConnected || this.gameState !== 'fighting') return;

                const acceleration = event.acceleration || event.accelerationIncludingGravity;
                if (!acceleration) return;

                // Ïä§Ïúô Í∞êÏßÄ
                const now = Date.now();
                if (now - this.lastSwingTime < this.swingCooldown) return;

                const magnitude = Math.sqrt(
                    acceleration.x ** 2 + 
                    acceleration.y ** 2 + 
                    acceleration.z ** 2
                );

                if (magnitude > this.swingThreshold) {
                    this.detectSwingDirection(acceleration);
                    this.lastSwingTime = now;
                }
            }

            processOrientationData(event) {
                // Ï∂îÌõÑ Í≤ÄÏùò Í∞ÅÎèÑ ÏãúÍ∞ÅÌôîÏóê ÏÇ¨Ïö© Í∞ÄÎä•
                this.lastSensorData = {
                    alpha: event.alpha,
                    beta: event.beta,
                    gamma: event.gamma
                };
            }

            detectSwingDirection(acceleration) {
                const absX = Math.abs(acceleration.x);
                const absY = Math.abs(acceleration.y);
                const absZ = Math.abs(acceleration.z);

                let direction = 'unknown';
                
                // ÏàòÏßÅ/ÏàòÌèâ ÌåêÎã®
                if (absY > absX && absY > absZ) {
                    direction = acceleration.y > 0 ? 'vertical_up' : 'vertical_down';
                } else if (absX > absY && absX > absZ) {
                    direction = acceleration.x > 0 ? 'horizontal_right' : 'horizontal_left';
                }

                // Í≥µÍ≤© Î∞©Ìñ• Ï†ïÍ∑úÌôî
                let attackType = 'unknown';
                if (direction.includes('vertical')) {
                    attackType = 'vertical';
                } else if (direction.includes('horizontal')) {
                    attackType = 'horizontal';
                }

                if (attackType !== 'unknown') {
                    this.performAttack(attackType);
                }
            }

            performAttack(attackType) {
                // Í≤Ä Í≥µÍ≤© Ïï†ÎãàÎ©îÏù¥ÏÖò
                this.elements.sword.classList.add('attacking');
                setTimeout(() => {
                    this.elements.sword.classList.remove('attacking');
                }, 500);

                // Í≥µÍ≤© Î∞©Ìñ• ÌëúÏãú
                this.showAttackDirection(attackType);

                // ÏÑúÎ≤ÑÏóê Í≥µÍ≤© Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ°
                if (this.socket) {
                    this.socket.emit('sword-attack', {
                        sessionCode: this.sessionCode,
                        playerId: this.playerNumber,
                        attackType: attackType,
                        timestamp: Date.now()
                    });
                }

                // ÏßÑÎèô ÌîºÎìúÎ∞±
                this.vibrateDevice(100);

                console.log(`‚öîÔ∏è ${attackType} Í≥µÍ≤© Ïã§Ìñâ`);
            }

            startDefense() {
                if (!this.isConnected || this.gameState !== 'fighting') return;

                this.isDefending = true;
                this.elements.defenseButton.classList.add('defending');
                this.elements.sword.classList.add('defending');

                // ÏÑúÎ≤ÑÏóê Î∞©Ïñ¥ ÏãúÏûë ÏïåÎ¶º
                if (this.socket) {
                    this.socket.emit('sword-defend-start', {
                        sessionCode: this.sessionCode,
                        playerId: this.playerNumber,
                        timestamp: Date.now()
                    });
                }

                console.log('üõ°Ô∏è Î∞©Ïñ¥ ÏãúÏûë');
            }

            stopDefense() {
                if (!this.isConnected) return;

                this.isDefending = false;
                this.elements.defenseButton.classList.remove('defending');
                this.elements.sword.classList.remove('defending');
                this.elements.defenseDirection.classList.remove('show');

                // ÏÑúÎ≤ÑÏóê Î∞©Ïñ¥ Ï¢ÖÎ£å ÏïåÎ¶º
                if (this.socket) {
                    this.socket.emit('sword-defend-stop', {
                        sessionCode: this.sessionCode,
                        playerId: this.playerNumber,
                        timestamp: Date.now()
                    });
                }

                console.log('üõ°Ô∏è Î∞©Ïñ¥ Ï¢ÖÎ£å');
            }

            showAttackDirection(attackType) {
                const directionMap = {
                    'vertical': '‚¨áÔ∏è ÏàòÏßÅ Í≥µÍ≤©',
                    'horizontal': '‚¨ÖÔ∏è‚û°Ô∏è ÏàòÌèâ Í≥µÍ≤©'
                };

                this.elements.attackDirection.textContent = directionMap[attackType] || '‚öîÔ∏è Í≥µÍ≤©';
                this.elements.attackDirection.classList.add('show');

                setTimeout(() => {
                    this.elements.attackDirection.classList.remove('show');
                }, 1000);
            }

            showDefenseDirection(requiredDefenseType) {
                const directionMap = {
                    'vertical': '‚¨ÖÔ∏è‚û°Ô∏è ÏàòÌèâÏúºÎ°ú Î∞©Ïñ¥ÌïòÏÑ∏Ïöî!',
                    'horizontal': '‚¨áÔ∏è‚¨ÜÔ∏è ÏàòÏßÅÏúºÎ°ú Î∞©Ïñ¥ÌïòÏÑ∏Ïöî!'
                };

                this.elements.defenseDirection.textContent = directionMap[requiredDefenseType] || '';
                this.elements.defenseDirection.classList.add('show');
            }

            connectToGame() {
                this.socket = io();

                this.socket.on('connect', () => {
                    console.log('üîó ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏÑ±Í≥µ');
                    this.socket.emit('join-sword-fight', {
                        sessionCode: this.sessionCode,
                        type: 'sensor'
                    });
                });

                this.socket.on('sword-fight-joined', (data) => {
                    this.isConnected = true;
                    this.playerNumber = data.playerId;
                    this.elements.connectionStatus.textContent = 'Ïó∞Í≤∞Îê®';
                    this.elements.connectionStatus.classList.remove('status-disconnected');
                    this.elements.connectionStatus.classList.add('status-connected');
                    this.elements.playerNumber.textContent = `Player ${this.playerNumber}`;
                    this.elements.defenseButton.disabled = false;
                    
                    this.showMessage('Í≤åÏûÑÏóê Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§!', 'success');
                });

                this.socket.on('sword-fight-state-change', (data) => {
                    this.handleGameStateChange(data);
                });

                this.socket.on('sword-fight-countdown', (data) => {
                    this.showCountdown(data.count);
                });

                this.socket.on('sword-fight-health-update', (data) => {
                    this.updateHealth(data);
                });

                this.socket.on('sword-fight-attack-incoming', (data) => {
                    this.handleIncomingAttack(data);
                });

                this.socket.on('sword-fight-result', (data) => {
                    this.handleBattleResult(data);
                });

                this.socket.on('disconnect', () => {
                    this.isConnected = false;
                    this.elements.connectionStatus.textContent = 'Ïó∞Í≤∞ ÎÅäÍπÄ';
                    this.elements.connectionStatus.classList.remove('status-connected');
                    this.elements.connectionStatus.classList.add('status-disconnected');
                    this.elements.defenseButton.disabled = true;
                    
                    this.showMessage('ÏÑúÎ≤Ñ Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§.', 'error');
                });
            }

            handleGameStateChange(data) {
                this.gameState = data.state;
                
                const messages = {
                    'waiting': 'ÏÉÅÎåÄÎ∞©ÏùÑ Í∏∞Îã§Î¶¨Îäî Ï§ë...',
                    'ready': 'Í≤åÏûÑ Ï§ÄÎπÑ ÏôÑÎ£å!',
                    'countdown': 'Í≥ß Ï†ÑÌà¨Í∞Ä ÏãúÏûëÎê©ÎãàÎã§!',
                    'fighting': '‚öîÔ∏è Ï†ÑÌà¨ ÏãúÏûë! Í≥µÍ≤©ÌïòÍ±∞ÎÇò Î∞©Ïñ¥ÌïòÏÑ∏Ïöî!',
                    'finished': 'Í≤åÏûÑ Ï¢ÖÎ£å'
                };

                const messageClasses = {
                    'waiting': 'message-waiting',
                    'ready': 'message-ready',
                    'countdown': 'message-ready',
                    'fighting': 'message-fighting',
                    'finished': 'message-waiting'
                };

                this.elements.statusMessage.textContent = messages[this.gameState];
                this.elements.statusMessage.className = `message-text ${messageClasses[this.gameState]}`;
            }

            showCountdown(count) {
                if (count > 0) {
                    this.elements.countdownNumber.textContent = count;
                    this.elements.countdownOverlay.classList.remove('hidden');
                } else {
                    this.elements.countdownNumber.textContent = 'FIGHT!';
                    setTimeout(() => {
                        this.elements.countdownOverlay.classList.add('hidden');
                    }, 1000);
                }
            }

            updateHealth(data) {
                this.myHealth = data.myHealth;
                this.enemyHealth = data.enemyHealth;
                
                this.elements.myHealth.textContent = '‚ù§Ô∏è'.repeat(this.myHealth) + 'üíî'.repeat(5 - this.myHealth);
                this.elements.enemyHealth.textContent = '‚ù§Ô∏è'.repeat(this.enemyHealth) + 'üíî'.repeat(5 - this.enemyHealth);
            }

            handleIncomingAttack(data) {
                if (data.targetPlayerId !== this.playerNumber) return;

                // ÌïÑÏöîÌïú Î∞©Ïñ¥ Î∞©Ìñ• ÌëúÏãú
                const requiredDefense = data.attackType === 'vertical' ? 'horizontal' : 'vertical';
                this.showDefenseDirection(data.attackType);

                // ÏßÑÎèôÏúºÎ°ú Í≤ΩÍ≥†
                this.vibrateDevice([200, 100, 200]);
            }

            handleBattleResult(data) {
                if (data.result === 'hit') {
                    if (data.victimPlayerId === this.playerNumber) {
                        this.showImpactEffect();
                        this.showMessage('Í≥µÍ≤©ÏùÑ Î∞õÏïòÏäµÎãàÎã§!', 'error');
                        this.vibrateDevice(300);
                    } else {
                        this.showMessage('Í≥µÍ≤©Ïù¥ ÏÑ±Í≥µÌñàÏäµÎãàÎã§!', 'success');
                        this.vibrateDevice(150);
                    }
                } else if (data.result === 'blocked') {
                    this.showMessage('Í≥µÍ≤©Ïù¥ Î∞©Ïñ¥ÎêòÏóàÏäµÎãàÎã§!', 'warning');
                    this.vibrateDevice(100);
                } else if (data.result === 'miss') {
                    this.showMessage('Í≥µÍ≤©Ïù¥ ÎπóÎÇòÍ∞îÏäµÎãàÎã§!', 'info');
                } else if (data.result === 'simultaneous') {
                    this.showImpactEffect();
                    this.showMessage('ÎèôÏãú Í≥µÍ≤©! Îëò Îã§ Îç∞ÎØ∏ÏßÄ!', 'warning');
                    this.vibrateDevice([100, 50, 100, 50, 100]);
                }
            }

            showImpactEffect() {
                const effect = document.createElement('div');
                effect.className = 'impact-effect';
                document.body.appendChild(effect);

                setTimeout(() => {
                    document.body.removeChild(effect);
                }, 600);
            }

            createBackgroundEffects() {
                // Ïä§ÌååÌÅ¨ Ìö®Í≥º ÏÉùÏÑ±
                setInterval(() => {
                    if (this.gameState === 'fighting') {
                        this.createSpark();
                    }
                }, 2000);
            }

            createSpark() {
                const spark = document.createElement('div');
                spark.className = 'spark';
                spark.style.left = Math.random() * 100 + '%';
                spark.style.top = Math.random() * 100 + '%';
                spark.style.animationDelay = Math.random() * 1 + 's';
                
                this.elements.backgroundEffects.appendChild(spark);

                setTimeout(() => {
                    this.elements.backgroundEffects.removeChild(spark);
                }, 3000);
            }

            showMessage(message, type = 'info') {
                const colors = {
                    'success': 'var(--success)',
                    'error': 'var(--error)',
                    'warning': 'var(--warning)',
                    'info': 'var(--text-primary)'
                };

                this.elements.statusMessage.textContent = message;
                this.elements.statusMessage.style.color = colors[type];

                setTimeout(() => {
                    this.elements.statusMessage.style.color = '';
                }, 3000);
            }

            vibrateDevice(pattern) {
                if (navigator.vibrate) {
                    navigator.vibrate(pattern);
                }
            }

            disconnect() {
                if (this.socket) {
                    this.socket.disconnect();
                }
            }
        }

        // ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî
        window.addEventListener('load', () => {
            window.swordFightClient = new SwordFightSensorClient();
        });

        // Ï†ïÎ¶¨
        window.addEventListener('beforeunload', () => {
            if (window.swordFightClient) {
                window.swordFightClient.disconnect();
            }
        });
    </script>
</body>
</html>